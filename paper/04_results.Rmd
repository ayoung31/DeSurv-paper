```{r setup}
library(targets)
library(stringr)
library(dplyr)
library(ggplot2)
library(survival)
library(survminer)
library(cowplot)
library(enrichplot)
library(magick)
library(Seurat)
library(gt)
library(VAM)
library(grid)
library(viridis)
library(ggplotify)
library(NMF)


tar_load(sim_figs_by_scenario)

tar_load(fig_extval_panel_a_tcgacptac)
tar_load(fig_extval_panel_b_tcgacptac)
tar_load(fig_extval_panel_c_tcgacptac)

tar_load(sim_figs_by_scenario)

scenario_ids = sapply(sim_figs_by_scenario,function(x) x$scenario_id)
analysis_ids = sapply(sim_figs_by_scenario,function(x) x$analysis_id)

alt = which(scenario_ids=="R0_easy" & analysis_ids == "bo_tune_ntop")
null = which(scenario_ids=="R00_null" & analysis_ids == "bo_tune_ntop")

alt_plots = sim_figs_by_scenario[[alt]]
null_plots = sim_figs_by_scenario[[null]]
```


## Model Overview {.unnumbered}

We have developed an integrated framework, DeSurv, that couples Nonnegative Matrix Factorization (NMF) with Cox proportional hazards regression to identify latent gene-expression programs associated with patient survival (Figure \@ref(fig:fig-schema)). The model takes as input a bulk expression matrix of $p$ genes by $n$ patients ($X_{Train}$) together with corresponding survival times ($y_{Train}$) and censoring indicators ($\delta_{Train}$) (Figure \ref{fig:schema}A). 

DeSurv optimizes a joint objective combining the NMF reconstruction loss and the Cox model's log-partial likelihood, weighted by a supervision parameter ($\alpha$) that determines the relative contribution of each term (fig. \ref{fig:schema}B):
\begin{align}
  (1-\alpha)\ &\mathcal{L}_{NMF}(X_{Train} \approx WH)\nonumber \\ - \alpha\ &\mathcal{L}_{Cox}(X_{Train}^TW\beta,y_{Train},\delta_{Train})
\end{align}
When $\alpha=0$, the method reduces to standard unsupervised NMF; when $\alpha>0$, survival information directly guides the learned factors toward prognostic structure. 

Within this framework, the product ($X_{Train}^TW$) represents patient-level factor scores - the inferred burden of each latent program across subjects. These factor scores serve as covariates in the Cox model, and their regression coefficients ($\beta$) indicate whether higher activity of a given program corresponds to improved or reduced survival. 

Model training yields gene weights ($\hat{W}$), factor loadings ($\hat{H}$), and Cox coefficients ($\hat{\beta}$) (Figure \ref{fig:schema}C), where the inner dimension ($k$) specifies the number of latent factors. Genes with high gene weights in one factor and low gene weights in all others define the factor-specific signature genes (Figure \ref{fig:schema}D). By integrating survival supervision into the factorization, DeSurv not only reconstructs the underlying expression structure, preserving biologial interpretability, but also guides latent factors to be prognostically informative. Subsequent analyses can therefore focus on the survival-associated gene programs (Figure \ref{fig:schema}E).
```{r fig-schema, fig.cap = "Overview of the DeSurv framework and data-driven model selection. (A) DeSurv integrates nonnegative matrix factorization (NMF) with survival modeling to learn prognostic gene programs from a gene expression matrix $X$. NMF decomposes $X \\approx WH$, where $W$ represents gene programs and $H$ sample loadings; the learned programs $W$ are shared with a Cox proportional hazards model that links factor-derived scores $Z = X^\\top W$ to survival outcomes via regression coefficients $\\beta$. A tuning parameter $\\alpha$ controls the balance between unsupervised structure learning ($\\alpha = 0$) and supervised survival association ($\\alpha = 1$). (B) Model complexity ($k$), supervision strength ($\\alpha$), and regularization ($\\lambda$) are selected via Bayesian optimization using cross-validated concordance index. \\label{fig:schema}", fig.env='figure*', fig.pos='t', out.height= "6in", out.width='\\textwidth'}

knitr::include_graphics(file.path("..","figures", "model_schematic_final.pdf"))
```



## Bayesian optimisation selects the DeSurv hyperparameters ($k$, $\alpha$) {.unnumbered}
We now tune DeSurv with Bayesian optimisation (BO) rather than enumerating a dense cross-validation grid. Each BO evaluation fits the model for a single combination of $k$, $\alpha$, and penalty weights, measuring the mean validation C-index. A Gaussian-process surrogate models this surface and proposes new evaluations that balance exploration and exploitation, allowing the search to concentrate rapidly on high-performing regions.

Figure \ref{fig:bo} summarises the optimisation run. Panel A reports the best observed cross-validated C-index at each $k$ for the supervised and $\alpha=0$ searches, with error bars denoting the cross-validation standard error across folds. The final configuration of the supervised search converges to $k=3$ and $\alpha=0.7$, which provided the highest cross-validated C-index encountered by BO.

For reference we still report standard NMF heuristics (Panels B-D: cophenetic, residuals, and silhouette), which historically guide rank selection when a supervised criterion is unavailable. These diagnostics disagree on the optimal $k$, underscoring the benefit of the BO-guided DeSurv procedure that explicitly maximises prognostic accuracy.

```{r fig-bo, fig.width = 6, fig.height= 5.5, fig.cap = "Ambiguity of rank selection in standard NMF and principled model selection in DeSurv. (A–C) Common criteria used to select the number of components in standard NMF—reconstruction error, cophenetic correlation, and silhouette width—exhibit non-monotonic or weakly differentiated patterns across ranks, leading to ambiguous or conflicting choices of $k$ in real PDAC datasets. (D) In contrast, DeSurv enables joint selection of model complexity and supervision strength through cross-validated survival performance. Heatmap of cross-validated concordance index across the number of components ($k$) and supervision strength ($\\alpha$) reveals a well-defined performance landscape, allowing principled identification of an optimal model configuration. (E) Simulation-based comparison of selected model rank. Distributions of selected $k$ across repeated simulations show that DeSurv, using Bayesian optimization, consistently recovers the true underlying rank ($k = 3$), whereas standard NMF followed by post hoc Cox modeling exhibits greater variability and a tendency toward under-selection. \\label{fig:bo}", fig.env='figure*', fig.pos='t', out.height= "5.5in", out.width="6in"}

tar_load(fig_bo_heat_tcgacptac)
tar_load(fig_residuals_tcgacptac)
tar_load(fig_cophenetic_tcgacptac)
tar_load(fig_silhouette_tcgacptac)

# upper = plot_grid(fig_bo_cvk_tcgacptac,fig_bo_cvalpha_tcgacptac,labels=c("A","B"))
upper = plot_grid(fig_residuals_tcgacptac,
                  fig_cophenetic_tcgacptac,
                  fig_silhouette_tcgacptac,
                  ncol = 3,
                  labels = c("A","B","C"))

k_hist = plot_grid(alt_plots$k_hist,NULL,nrow=2,rel_heights = c(4,1))

lower = plot_grid(fig_bo_heat_tcgacptac,
                  k_hist,ncol=2,labels=c("D","E"),rel_widths = c(3,2))

plot_grid(upper,lower,nrow=2,rel_heights = c(2,3))

```


## DeSurv improves selection of prognostic gene signatures {.unnumbered}
To test whether supervision improves the selection of prognostic gene signatures, we used simulations with known lethal factors and tuned the number of top genes per factor (\texttt{n\_top}) using BO. We compared the supervised DeSurv model to the unsupervised $\alpha=0$ baseline across simulation regimes. Figure \ref{fig:sim}A shows the distribution of test C-index values, while Figure \ref{fig:sim}B reports the precision of recovered prognostic genes (mean across lethal factors). DeSurv consistently yields higher C-index and improved precision, indicating that survival supervision helps focus signatures on truly prognostic genes rather than reconstruction-only structure.
```{r fig-sim-ntop-scenarios, fig.width = 6.5, fig.height = 3, fig.cap = "Performance comparison between DeSurv and unsupervised NMF ($\\alpha = 0$) in simulation. (A) Distribution of cross-validated concordance index shows that DeSurv achieves consistently higher survival prediction performance than the unsupervised baseline. (B) Precision for recovering true underlying gene programs is substantially higher for DeSurv, whereas the unsupervised approach exhibits near-zero precision, indicating poor alignment with the ground-truth factors. \\label{fig:sim}", fig.env='figure*', fig.pos='t', out.width='\\textwidth'}



plot_grid(alt_plots$cindex_box + labs(title=NULL) + scale_y_continuous(limits=c(.5,1)),
          alt_plots$precision_box + labs(title=NULL),ncol=2,labels=c("A","B"))
```



## Survival-informed factorization reorganizes transcriptional structure in pancreatic cancer {.unnumbered}
To assess the biological structure captured by standard nonnegative matrix factorization (NMF) and DeSurv, we examined the overlap between factor-specific gene rankings and established PDAC gene programs (Fig. \ref{fig:bio}A-B). Both approaches recovered recognizable biological signals; however, the organization of these signals across factors differed in ways that reflect the objectives of each method.

In the standard NMF solution, factors largely reflected dominant sources of transcriptional variance. One factor was strongly associated with exocrine-associated expression and opposed immune and stromal signatures, consistent with a bulk composition axis separating normal or differentiated tissue from non-epithelial tumor content. A second factor aligned with classical tumor identity, while a third aggregated immune, fibroblast, and extracellular matrix–related programs into a single microenvironmental component. These patterns indicate that standard NMF captures major biological variation in bulk PDAC expression data, but merges distinct microenvironmental states and allocates substantial model capacity to differentiation-driven signals.

By contrast, DeSurv produced a factorization that emphasized axes of variation more closely aligned with disease aggressiveness. One factor corresponded to classical tumor programs opposing basal-like expression, whereas another isolated an activated microenvironmental state characterized by immune infiltration and stromal remodeling. A third factor captured aggressive tumor-intrinsic programs associated with basal-like biology. Notably, exocrine-associated expression did not dominate any DeSurv factor, suggesting that survival-informed optimization deprioritizes differentiation-related variation that is weakly associated with outcome.

These differences were reflected quantitatively by contrasting the fraction of expression variance explained by each factor with its contribution to survival (Fig. \ref{fig:bio}C). In the standard NMF solution, the factor explaining the largest proportion of transcriptional variance contributed little to survival, consistent with its enrichment for exocrine and composition-driven programs. In contrast, DeSurv concentrated survival signal into a single factor that explained substantially more variation in outcome despite accounting for a smaller fraction of expression variance. The remaining DeSurv factors contributed minimal survival signal, indicating that survival-relevant information was not diffusely distributed across components.

To further characterize how DeSurv reorganizes the transcriptional structure learned by standard NMF, we examined the correspondence between factors derived from the two methods (Fig. \ref{fig:bio}D). Tumor-intrinsic structure was largely preserved, with one DeSurv factor showing strong correspondence to the classical tumor–associated NMF factor. In contrast, the microenvironmental factor identified by standard NMF mapped primarily to a single DeSurv factor enriched for activated immune and stromal programs, indicating that DeSurv refines variance-driven microenvironmental structure into a survival-aligned axis. Notably, the NMF factor dominated by exocrine-associated expression did not correspond strongly to any single DeSurv factor, consistent with the suppression of differentiation- and composition-driven signals observed in survival-informed factorization. Together, these results indicate that DeSurv selectively preserves tumor and microenvironmental structure while reorganizing or deprioritizing axes of variation that contribute little to survival.
```{r fig-bio, fig.cap="Survival-informed factorization reorganizes transcriptional structure relative to variance-driven NMF. (A) Correlation of standard NMF factor gene rankings with established pancreatic ductal adenocarcinoma (PDAC) gene programs. NMF recovers variance-dominant structure, including an exocrine-associated factor opposing immune and stromal signatures, a classical tumor factor, and a composite microenvironmental factor. (B) Corresponding correlations for DeSurv. DeSurv isolates tumor-intrinsic classical and basal-like programs and resolves an activated immune–stromal microenvironment, while exocrine-associated expression does not dominate any factor. Asterisks indicate significant correlations after multiple testing correction. (C) Fraction of expression variance explained versus survival contribution for each factor, quantified by the change in partial log-likelihood from univariate Cox models. Standard NMF factors explain substantial variance with minimal survival relevance, whereas DeSurv concentrates survival signal into a single factor despite explaining less expression variance. (D) Pairwise correspondence between NMF and DeSurv factors. Tumor-intrinsic structure is preserved across methods, while variance-driven microenvironmental structure is reorganized into a survival-aligned axis; the exocrine-dominated NMF factor shows no strong one-to-one correspondence. \\label{fig:bio}", fig.env='figure*', fig.pos='t', out.height= "4.5in", out.width='\\textwidth'}

tar_load(fig_gene_overlap_heatmap_desurv_tcgacptac)
tar_load(fig_gene_overlap_heatmap_std_desurvk_tcgacptac)
tar_load(fig_variation_explained_tcgacptac)
tar_load(fig_desurv_std_correlation_tcgacptac)

right = plot_grid(fig_variation_explained_tcgacptac +
                    theme(
                      legend.position = c(1, 0.65),   # x, y in [0,1]
                      legend.justification = c(1, 0),   # anchor point of legend box
                      legend.background = element_rect(color="black")
                    ),
          fig_desurv_std_correlation_tcgacptac,
          nrow=2,labels=c("C","D"))
legend = get_legend(fig_gene_overlap_heatmap_desurv_tcgacptac)
plot_grid(fig_gene_overlap_heatmap_std_desurvk_tcgacptac + theme(legend.position = "none"),fig_gene_overlap_heatmap_desurv_tcgacptac,right,ncol=3,labels=c("A","B",""))

```


## External validation with projected DeSurv factor scores {.unnumbered}
To evaluate the generalizability of DeSurv-derived prognostic signatures, we projected the DeSurv weights onto multiple independent PDAC cohorts (Dijk, PACA-AU RNA-seq and microarray, Moffitt, and Puleo). We selected the two most prognostic factors using \texttt{select\_desurv\_factors}, rank-transformed expression within each sample over the union of the selected factor gene lists, and computed validation scores as $Z_{val} = X_{val}^T W$ restricted to the top-gene signatures. This yields continuous factor score vectors for each cohort without clustering.

Figure \@ref(fig:fig-extval)A shows the ranked expression heatmap for the selected factor gene signatures, annotated with the continuous factor scores and the PurIST, DeCAF, and dataset labels. Figure \@ref(fig:fig-extval)B plots the top two factor scores for all samples, colored by PurIST subtype and shaped by DeCAF subtype to show how tumor- and stroma-associated programs align across cohorts. For survival assessment, we discretized each factor score within each cohort at its median and intersected the high/low calls to form four groups; Kaplan–Meier curves for these groups are shown in Figure \@ref(fig:fig-extval)C. Because DeSurv was trained only on TCGA-PAAD/CPTAC, these analyses represent an independent validation of prognostic signal transfer to external datasets.
```{r fig-extval, fig.cap="External cohort validation. A. Heatmap of ranked expression values for genes in the selected DeSurv factor signatures with continuous factor-score annotations plus PurIST, DeCAF, and dataset labels. B. Scatter plot of the top two factor scores, colored by PurIST subtype and shaped by DeCAF subtype. C. Kaplan–Meier curves for the four groups formed by per-cohort median splits of the two factor scores.", fig.env='figure*', fig.pos='t', out.width='0.32\\textwidth'}


```


## Bladder cancer analysis {.unnumbered}
We will report a focused bladder cancer analysis here, including a dedicated figure. Placeholder text: summary of bladder cohort preprocessing, DeSurv factor interpretation, and survival stratification results to be added once the bladder figure is finalized.

```{r}

```

