```{r setup}
library(targets)
library(stringr)
library(dplyr)
library(ggplot2)
library(survival)
library(survminer)
library(cowplot)
library(enrichplot)
library(magick)
library(Seurat)
library(gt)
library(VAM)
library(grid)
library(viridis)
library(ggplotify)
library(NMF)


tar_load(sim_figs_by_scenario)

tar_load(fig_extval_panel_a_tcgacptac)
tar_load(fig_extval_panel_b_tcgacptac)
tar_load(fig_extval_panel_c_tcgacptac)

tar_load(sim_figs_by_scenario)

scenario_ids = sapply(sim_figs_by_scenario,function(x) x$scenario_id)
analysis_ids = sapply(sim_figs_by_scenario,function(x) x$analysis_id)

alt = which(scenario_ids=="R0_easy" & analysis_ids == "bo_tune_ntop")
null = which(scenario_ids=="R00_null" & analysis_ids == "bo_tune_ntop")

alt_plots = sim_figs_by_scenario[[alt]]
null_plots = sim_figs_by_scenario[[null]]
```


## Model Overview {.unnumbered}

We have developed an integrated framework, DeSurv, that couples Nonnegative Matrix Factorization (NMF) with Cox proportional hazards regression to identify latent gene-expression programs associated with patient survival (Figure \@ref(fig:fig-schema)). The model takes as input a bulk expression matrix of $p$ genes by $n$ patients ($X_{Train}$) together with corresponding survival times ($y_{Train}$) and censoring indicators ($\delta_{Train}$) (Figure \@ref(fig:fig-schema)A). 

DeSurv optimizes a joint objective combining the NMF reconstruction loss and the Cox model's log-partial likelihood, weighted by a supervision parameter ($\alpha$) that determines the relative contribution of each term (Figure \@ref(fig:fig-schema)B):
\begin{align}
  (1-\alpha)\ &\mathcal{L}_{NMF}(X_{Train} \approx WH)\nonumber \\ - \alpha\ &\mathcal{L}_{Cox}(X_{Train}^TW\beta,y_{Train},\delta_{Train})
\end{align}
When $\alpha=0$, the method reduces to standard unsupervised NMF; when $\alpha>0$, survival information directly guides the learned factors toward prognostic structure. 

Within this framework, the product ($X_{Train}^TW$) represents patient-level factor scores - the inferred burden of each latent program across subjects. These factor scores serve as covariates in the Cox model, and their regression coefficients ($\beta$) indicate whether higher activity of a given program corresponds to improved or reduced survival. 

Model training yields gene weights ($\hat{W}$), factor loadings ($\hat{H}$), and Cox coefficients ($\hat{\beta}$) (Figure \@ref(fig:fig-schema)C), where the inner dimension ($k$) specifies the number of latent factors. Genes with high gene weights in one factor and low gene weights in all others define the factor-specific signature genes (Figure \@ref(fig:fig-schema)D). By integrating survival supervision into the factorization, DeSurv not only reconstructs the underlying expression structure, preserving biologial interpretability, but also guides latent factors to be prognostically informative. Subsequent analyses can therefore focus on the survival-associated gene programs (Figure \@ref(fig:fig-schema)E).
```{r fig-schema, fig.cap = "Overview of the DeSurv framework and data-driven model selection. (A) DeSurv integrates nonnegative matrix factorization (NMF) with survival modeling to learn prognostic gene programs from a gene expression matrix $X$. NMF decomposes $X \\approx WH$, where $W$ represents gene programs and $H$ sample loadings; the learned programs $W$ are shared with a Cox proportional hazards model that links factor-derived scores $Z = X^\\top W$ to survival outcomes via regression coefficients $\\beta$. A tuning parameter $\\alpha$ controls the balance between unsupervised structure learning ($\\alpha = 0$) and supervised survival association ($\\alpha = 1$). (B) Model complexity ($k$), supervision strength ($\\alpha$), and regularization ($\\lambda$) are selected via Bayesian optimization using cross-validated concordance index.", fig.env='figure*', fig.pos='t', out.height= "6in", out.width='\\textwidth'}

knitr::include_graphics(file.path("..","figures", "model_schematic_final.pdf"))
```



## Bayesian optimisation selects the DeSurv hyperparameters ($k$, $\alpha$) {.unnumbered}
We now tune DeSurv with Bayesian optimisation (BO) rather than enumerating a dense cross-validation grid. Each BO evaluation fits the model for a single combination of $k$, $\alpha$, and penalty weights, measuring the mean validation C-index. A Gaussian-process surrogate models this surface and proposes new evaluations that balance exploration and exploitation, allowing the search to concentrate rapidly on high-performing regions.

Figure \@ref(fig:fig-bo) summarises the optimisation run. Panel A reports the best observed cross-validated C-index at each $k$ for the supervised and $\alpha=0$ searches, with error bars denoting the cross-validation standard error across folds. The final configuration of the supervised search converges to $k=3$ and $\alpha=0.7$, which provided the highest cross-validated C-index encountered by BO.

For reference we still report standard NMF heuristics (Panels B-D: cophenetic, residuals, and silhouette), which historically guide rank selection when a supervised criterion is unavailable. These diagnostics disagree on the optimal $k$, underscoring the benefit of the BO-guided DeSurv procedure that explicitly maximises prognostic accuracy.

```{r fig-bo, fig.width = 6, fig.height= 5.5, fig.cap = "Ambiguity of rank selection in standard NMF and principled model selection in DeSurv. (A–C) Common criteria used to select the number of components in standard NMF—reconstruction error, cophenetic correlation, and silhouette width—exhibit non-monotonic or weakly differentiated patterns across ranks, leading to ambiguous or conflicting choices of $k$ in real PDAC datasets. (D) In contrast, DeSurv enables joint selection of model complexity and supervision strength through cross-validated survival performance. Heatmap of cross-validated concordance index across the number of components ($k$) and supervision strength ($\\alpha$) reveals a well-defined performance landscape, allowing principled identification of an optimal model configuration. (E) Simulation-based comparison of selected model rank. Distributions of selected $k$ across repeated simulations show that DeSurv, using Bayesian optimization, consistently recovers the true underlying rank ($k = 3$), whereas standard NMF followed by post hoc Cox modeling exhibits greater variability and a tendency toward under-selection.", fig.env='figure*', fig.pos='t', out.height= "5.5in", out.width="6in"}

tar_load(fig_bo_heat_tcgacptac)
tar_load(fig_residuals_tcgacptac)
tar_load(fig_cophenetic_tcgacptac)
tar_load(fig_silhouette_tcgacptac)

# upper = plot_grid(fig_bo_cvk_tcgacptac,fig_bo_cvalpha_tcgacptac,labels=c("A","B"))
upper = plot_grid(fig_residuals_tcgacptac,
                  fig_cophenetic_tcgacptac,
                  fig_silhouette_tcgacptac,
                  ncol = 3,
                  labels = c("A","B","C"))

k_hist = plot_grid(alt_plots$k_hist,NULL,nrow=2,rel_heights = c(4,1))

lower = plot_grid(fig_bo_heat_tcgacptac,
                  k_hist,ncol=2,labels=c("D","E"),rel_widths = c(3,2))

plot_grid(upper,lower,nrow=2,rel_heights = c(2,3))

```


## DeSurv improves selection of prognostic gene signatures {.unnumbered}
To test whether supervision improves the selection of prognostic gene signatures, we used simulations with known lethal factors and tuned the number of top genes per factor (\texttt{n\_top}) using BO. We compared the supervised DeSurv model to the unsupervised $\alpha=0$ baseline across simulation regimes. Figure \@ref(fig:fig-sim-ntop)A shows the distribution of test C-index values, while Figure \@ref(fig:fig-sim-ntop)B reports the precision of recovered prognostic genes (mean across lethal factors). DeSurv consistently yields higher C-index and improved precision, indicating that survival supervision helps focus signatures on truly prognostic genes rather than reconstruction-only structure.
```{r fig-sim-ntop-scenarios, fig.width = 6.5, fig.height = 3, fig.cap = "Performance comparison between DeSurv and unsupervised NMF ($\\alpha = 0$) in simulation. (A) Distribution of cross-validated concordance index shows that DeSurv achieves consistently higher survival prediction performance than the unsupervised baseline. (B) Precision for recovering true underlying gene programs is substantially higher for DeSurv, whereas the unsupervised approach exhibits near-zero precision, indicating poor alignment with the ground-truth factors.", fig.env='figure*', fig.pos='t', out.width='\\textwidth'}



plot_grid(alt_plots$cindex_box + labs(title=NULL) + scale_y_continuous(limits=c(.5,1)),
          alt_plots$precision_box + labs(title=NULL),ncol=2,labels=c("A","B"))
```



## DeSurv provides biologically interpretable gene signatures {.unnumbered}
For the selected DeSurv model ($k=3, \alpha=0.7$), we identified the top 50 factor-specific genes from each latent factor to characterize their underlying biological functions. Panels A-C of Figure \@ref(fig:fig-bio) summarize the results of an over-representation analysis (ORA) performed on these genes. The enrichment profiles reveal three distinct biological programs. Factor 1 is strongly enriched for immune-related pathways, including cytokine signaling, T-cell activation, and interferon response. Factor 2 shows enrichment for genes associated with normal pancreatic or exocrine function, suggesting that this component captures residual normal-tissue signal. Factor 3 is enriched for pathways linked to epithelial–mesenchymal transition, cell cycle progression, and KRAS signaling—features typically associated with the Basal-like subtype of pancreatic ductal adenocarcinoma (PDAC).

Survival analysis of the factor signature scores on the training data demonstrates clear prognostic stratification. High expression of Factor 1 is associated with longer overall survival (HR = 0.37, p < 2e-16), whereas Factor 3 is linked to significantly shorter survival (HR = 1.43, p = 2e-4). These trends are consistent with known biology: immune-infiltrated tumors generally exhibit improved prognosis, while Basal-like tumors are aggressive and clinically refractory. Factor 2, corresponding to the normal/exocrine signal, shows no significant association with survival (HR = 0.99, p = 0.91), indicating that while this component contributes to reconstructing the expression matrix, it does not carry prognostic information. This behavior illustrates a key property of DeSurv—its joint optimization ensures that the latent factors balance both survival relevance and expression reconstruction, preserving biologically necessary structure even when not directly linked to outcome.

Panel D of Figure \@ref(fig:fig-bio) further examines the correlation between DeSurv factors and previously published PDAC gene signatures. Factor 1 aligns with signatures from classical tumor, iCAF and restCAF stroma, and immune infiltration, all of which are associated with favorable prognosis. In contrast, Factor 3 correlates with Basal-like tumor, proCAF, and activated stromal programs, which are generally linked to poor outcomes. These overlaps suggest that each factor represents a composite axis of tumor–stroma-immune interaction, capturing biologically coherent programs that align with known PDAC ecosystems but arise de novo from the DeSurv model.
```{r fig-bio, fig.cap="A-C. Dotplots of ORA analysis of top 50 genes from each DeSurv derived factor. D. Correlation between the DeSurv gene weights matrix and previously published PDAC gene signatures.", fig.env='figure*', fig.pos='t', out.height= "4.5in", out.width='\\textwidth'}
tar_load(fig_dotplots_desurv_tcgacptac)
tar_load(fig_gene_overlap_heatmap_desurv_tcgacptac)
tar_load(fig_gene_overlap_heatmap_std_desurvk_tcgacptac)


```


## External validation with projected DeSurv factor scores {.unnumbered}
To evaluate the generalizability of DeSurv-derived prognostic signatures, we projected the DeSurv weights onto multiple independent PDAC cohorts (Dijk, PACA-AU RNA-seq and microarray, Moffitt, and Puleo). We selected the two most prognostic factors using \texttt{select\_desurv\_factors}, rank-transformed expression within each sample over the union of the selected factor gene lists, and computed validation scores as $Z_{val} = X_{val}^T W$ restricted to the top-gene signatures. This yields continuous factor score vectors for each cohort without clustering.

Figure \@ref(fig:fig-extval)A shows the ranked expression heatmap for the selected factor gene signatures, annotated with the continuous factor scores and the PurIST, DeCAF, and dataset labels. Figure \@ref(fig:fig-extval)B plots the top two factor scores for all samples, colored by PurIST subtype and shaped by DeCAF subtype to show how tumor- and stroma-associated programs align across cohorts. For survival assessment, we discretized each factor score within each cohort at its median and intersected the high/low calls to form four groups; Kaplan–Meier curves for these groups are shown in Figure \@ref(fig:fig-extval)C. Because DeSurv was trained only on TCGA-PAAD/CPTAC, these analyses represent an independent validation of prognostic signal transfer to external datasets.
```{r fig-extval, fig.cap="External cohort validation. A. Heatmap of ranked expression values for genes in the selected DeSurv factor signatures with continuous factor-score annotations plus PurIST, DeCAF, and dataset labels. B. Scatter plot of the top two factor scores, colored by PurIST subtype and shaped by DeCAF subtype. C. Kaplan–Meier curves for the four groups formed by per-cohort median splits of the two factor scores.", fig.env='figure*', fig.pos='t', out.width='0.32\\textwidth'}


```


## Bladder cancer analysis {.unnumbered}
We will report a focused bladder cancer analysis here, including a dedicated figure. Placeholder text: summary of bladder cohort preprocessing, DeSurv factor interpretation, and survival stratification results to be added once the bladder figure is finalized.

```{r}

```

