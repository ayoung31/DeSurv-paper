```{r setup}
library(targets)
library(stringr)
library(dplyr)
library(ggplot2)
library(survival)
library(survminer)
library(cowplot)
library(enrichplot)
library(magick)
library(Seurat)
library(gt)
library(VAM)
library(grid)
library(viridis)
library(ggplotify)
library(NMF)

repo_root <- normalizePath(if (file.exists("_targets.R")) "." else "..")

get_param_value <- function(name, default = NULL) {
  if (!exists("params", inherits = TRUE)) {
    return(default)
  }
  value <- params[[name]]
  if (is.null(value)) {
    return(default)
  }
  if (is.character(value) && !nzchar(value)) {
    return(default)
  }
  value
}

store <- tryCatch(tar_config_get("store"), error = function(e) "")
if (is.list(store)) {
  store <- store$store
}
if (!is.null(store) && nzchar(store)) {
  meta_check <- file.path(store, "meta", "meta")
  if (!file.exists(meta_check)) {
    store <- ""
  }
}
if (is.null(store) || !nzchar(store)) {
  store <- get_param_value("tar_store", "")
  if (is.null(store) || !nzchar(store)) {
    store <- "store_PKG_VERSION=tie_handling_GIT_BRANCH=main"
  }
  tar_config_set(store = store)
}

get_store_targets <- function(store_path) {
  meta_path <- file.path(store_path, "meta", "meta")
  if (!file.exists(meta_path)) {
    return(character(0))
  }
  meta <- read.delim(
    meta_path,
    sep = "|",
    header = TRUE,
    quote = "",
    comment.char = "",
    fill = TRUE,
    stringsAsFactors = FALSE
  )
  unique(meta$name)
}

invisible(lapply(list.files(file.path(repo_root, "R"), full.names = TRUE, pattern = "[.]R$"), source))
source(file.path(repo_root, "targets_configs.R"))

cmb_path <- file.path(repo_root, "data", "derv", "cmbSubtypes_formatted.RData")
if (file.exists(cmb_path)) {
  load(cmb_path)
}

bo_configs <- resolve_desurv_bo_configs(targets_bo_configs())
run_configs <- resolve_desurv_run_configs(targets_run_configs())
val_configs <- resolve_desurv_val_configs(targets_val_configs())

available_targets <- get_store_targets(store)

bo_label <- get_param_value("bo_label", "")
available_bo_targets <- grep("^tar_params_best_", available_targets, value = TRUE)
available_bo_targets <- available_bo_targets[!grepl("^tar_params_best_alpha0_", available_bo_targets)]
available_bo_labels <- sub("^tar_params_best_", "", available_bo_targets)
if (!nzchar(bo_label) || (length(available_bo_labels) && !bo_label %in% available_bo_labels)) {
  preferred_bo <- character(0)
  if (length(run_configs)) {
    preferred_bo <- unlist(lapply(run_configs, function(cfg) cfg$bo_key))
  }
  preferred_bo <- unique(preferred_bo[!is.na(preferred_bo) & nzchar(preferred_bo)])
  match_bo <- preferred_bo[preferred_bo %in% available_bo_labels][1]
  if (!is.na(match_bo) && nzchar(match_bo)) {
    bo_label <- match_bo
  } else if (length(available_bo_labels)) {
    bo_label <- available_bo_labels[1]
  } else if (length(bo_configs)) {
    bo_label <- names(bo_configs)[1]
  }
}
run_label <- get_param_value("run_label", "")
run_candidates <- grep("^tar_fit_desurv_", available_targets, value = TRUE)
run_candidates <- run_candidates[!grepl("^tar_fit_desurv_alpha0_", run_candidates)]
if (nzchar(bo_label) && length(run_candidates)) {
  run_candidates <- run_candidates[grepl(paste0("_", bo_label, "$"), run_candidates)]
}
available_run_labels <- unique(sub("^tar_fit_desurv_", "", run_candidates))
if (nzchar(bo_label) && length(available_run_labels)) {
  available_run_labels <- sub(paste0("_", bo_label, "$"), "", available_run_labels)
}
if (!nzchar(run_label) || (length(available_run_labels) && !run_label %in% available_run_labels)) {
  if (length(available_run_labels)) {
    run_label <- available_run_labels[1]
  } else if (length(run_configs)) {
    run_label <- names(run_configs)[1]
  }
}
val_label <- get_param_value("val_label", "")
if (!nzchar(val_label)) {
  if (length(val_configs)) {
    val_label <- names(val_configs)[1]
  } else {
    val_label <- ""
  }
}

make_target_name <- function(base, bo_label, run_label = NULL, val_label = NULL) {
  parts <- c(base, val_label, run_label, bo_label)
  parts <- parts[!is.na(parts) & nzchar(parts)]
  paste(parts, collapse = "_")
}

resolve_target_name <- function(base, bo_label, run_label = NULL, val_label = NULL, available = character(0)) {
  candidates <- unique(c(
    make_target_name(base, bo_label, run_label, val_label),
    make_target_name(base, bo_label, run_label, NULL),
    make_target_name(base, bo_label, NULL, NULL),
    base
  ))
  candidates <- candidates[nzchar(candidates)]
  if (length(available)) {
    match <- candidates[candidates %in% available][1]
    if (!is.na(match) && nzchar(match)) {
      return(match)
    }
  }
  candidates[1]
}

tar_read_name <- function(name) {
  tar_read_raw(name = name)
}

best_params <- tar_read_name(resolve_target_name(
  "tar_params_best",
  bo_label = bo_label,
  available = available_targets
))

```


## Model Overview {.unnumbered}

We have developed an integrated framework, DeSurv, that couples Nonnegative Matrix Factorization (NMF) with Cox proportional hazards regression to identify latent gene-expression programs associated with patient survival (Fig. 1). The model takes as input a bulk expression matrix of $p$ genes by $n$ patients ($X_{Train}$) together with corresponding survival times ($y_{Train}$) and censoring indicators ($\delta_{Train}$) (Fig. 1A). 

DeSurv optimizes a joint objective combining the NMF reconstruction loss and the Cox model's log-partial likelihood, weighted by a supervision parameter ($\alpha$) that determines the relative contribution of each term (Fig. 1B):
\begin{align}
  (1-\alpha)\ &\mathcal{L}_{NMF}(X_{Train} \approx WH)\nonumber \\ - \alpha\ &\mathcal{L}_{Cox}(X_{Train}^TW\beta,y_{Train},\delta_{Train})
\end{align}
When $\alpha=0$, the method reduces to standard unsupervised NMF; when $\alpha>0$, survival information directly guides the learned factors toward prognostic structure. 

Within this framework, the product ($X_{Train}^TW$) represents patient-level factor scores - the inferred burden of each latent program across subjects. These factor scores serve as covariates in the Cox model, and their regression coefficients ($\beta$) indicate whether higher activity of a given program corresponds to improved or reduced survival. 

Model training yields gene weights ($\hat{W}$), factor loadings ($\hat{H}$), and Cox coefficients ($\hat{\beta}$) (Fig. 1C), where the inner dimension ($k$) specifies the number of latent factors. Genes with high gene weights in one factor and low gene weights in all others define the factor-specific signature genes (Fig. 1D). By integrating survival supervision into the factorization, DeSurv not only reconstructs the underlying expression structure, preserving biologial interpretability, but also guides latent factors to be prognostically informative. Subsequent analyses can therefore focus on the survival-associated gene programs (Fig. 1E).
```{r fig-schema, fig.cap="DeSurv overview. Overview of the DeSurv training pipeline. A. The input is a preprocessed bulk gene expression matrix and patient survival outcomes. B. The Desurv model optimizes a joint NMF + Cox loss function. C. The DeSurv model estimates three quantities: Gene weights matrix (W), Subject loadings matrix (H), and regression coefficients from the Cox model (beta). D. We extract the exemplar genes from each signature in the gene weights matrix. E. The exemplar genes from survival associated factors provide prognostic gene signatures.", fig.env='figure*', fig.pos='t', out.height= "4in", out.width='\\textwidth'}

knitr::include_graphics(file.path(repo_root, "figures", "model_schematic_training.pdf"))
```



## Bayesian optimisation selects the DeSurv hyperparameters ($k$, $\alpha$) {.unnumbered}
We now tune DeSurv with Bayesian optimisation (BO) rather than enumerating a dense cross-validation grid. Each BO evaluation fits the model for a single combination of $k$, $\alpha$, and penalty weights, measuring the mean validation C-index. A Gaussian-process surrogate models this surface and proposes new evaluations that balance exploration and exploitation, allowing the search to concentrate rapidly on high-performing regions.

Figure \@ref(fig:fig-bo) summarises the optimisation run. Panels A and B report the best cross-validated C-index obtained for each rank and the corresponding supervision weight when $\alpha$ is tuned alongside $k$. Panel C visualises the full BO history through a violin plot of all C-index evaluations per rank, revealing the uncertainty around the best-performing $k$, while Panel D mirrors this distribution when the search is constrained to $\alpha=0$. Panels E and F use the Gaussian-process surrogate to show the BO posterior mean C-index and its 95\% confidence interval across $k$ for the supervised and $\alpha=0$ searches, respectively, capturing model-based uncertainty beyond the sampled runs. The final configuration of the supervised search converges to $k=3$ and $\alpha=0.7$, which provided the highest cross-validated C-index encountered by BO.

For reference we still report the standard NMF heuristics (Panel G), which historically guide rank selection when a supervised criterion is unavailable. These diagnostics disagree on the optimal $k$, underscoring the benefit of the BO-guided DeSurv procedure that explicitly maximises prognostic accuracy.

```{r fig-bo, fig.width = 6, fig.height= 5.5, fig.cap="A-B. Best cross-validated C-index per rank and corresponding supervision weight when $\\alpha$ is tuned jointly with k. C. Violin plot showing the distribution of CV C-index across all BO runs per k. D. Equivalent BO violin summary when $\\alpha$ is fixed to 0. E-F. GP posterior mean and 95% confidence bands of the CV C-index versus k for the supervised and $\\alpha$ = 0 searches. G. Conventional NMF diagnostics (cophenetic, dispersion, residuals, explained variance, silhouette, sparseness) for the unsupervised baseline." , fig.env='figure*', fig.pos='t', out.height= "5.5in", out.width="6in"}

knitr::include_graphics(file.path(repo_root, "figures", sprintf("fig_bo_%s_%s.pdf", run_label, bo_label)))
```


## DeSurv provides biologically interpretable gene signatures {.unnumbered}
For the selected DeSurv model ($k=3, \alpha=0.7$), we identified the top 50 factor-specific genes from each latent factor to characterize their underlying biological functions. Figures 3A–C summarize the results of an over-representation analysis (ORA) performed on these genes. The enrichment profiles reveal three distinct biological programs. Factor 1 is strongly enriched for immune-related pathways, including cytokine signaling, T-cell activation, and interferon response. Factor 2 shows enrichment for genes associated with normal pancreatic or exocrine function, suggesting that this component captures residual normal-tissue signal. Factor 3 is enriched for pathways linked to epithelial–mesenchymal transition, cell cycle progression, and KRAS signaling—features typically associated with the Basal-like subtype of pancreatic ductal adenocarcinoma (PDAC).

Survival analysis of the factor signature scores on the training data demonstrates clear prognostic stratification. High expression of Factor 1 is associated with longer overall survival (HR = 0.37, p < 2e-16), whereas Factor 3 is linked to significantly shorter survival (HR = 1.43, p = 2e-4). These trends are consistent with known biology: immune-infiltrated tumors generally exhibit improved prognosis, while Basal-like tumors are aggressive and clinically refractory. Factor 2, corresponding to the normal/exocrine signal, shows no significant association with survival (HR = 0.99, p = 0.91), indicating that while this component contributes to reconstructing the expression matrix, it does not carry prognostic information. This behavior illustrates a key property of DeSurv—its joint optimization ensures that the latent factors balance both survival relevance and expression reconstruction, preserving biologically necessary structure even when not directly linked to outcome.

Figure 3D further examines the correlation between DeSurv factors and previously published PDAC gene signatures. Factor 1 aligns with signatures from classical tumor, iCAF and restCAF stroma, and immune infiltration, all of which are associated with favorable prognosis. In contrast, Factor 3 correlates with Basal-like tumor, proCAF, and activated stromal programs, which are generally linked to poor outcomes. These overlaps suggest that each factor represents a composite axis of tumor–stroma-immune interaction, capturing biologically coherent programs that align with known PDAC ecosystems but arise de novo from the DeSurv model.
```{r fig-bio, fig.cap="A-C. Dotplots of ORA analysis of top 50 genes from each DeSurv derived factor. D. Correlation between the DeSurv gene weights matrix and previously published PDAC gene signatures.", fig.env='figure*', fig.pos='t', out.height= "4.5in", out.width='\\textwidth'}

knitr::include_graphics(file.path(repo_root, "figures", sprintf("fig_bio_%s_%s.pdf", run_label, bo_label)))
```


## Clustering patients from external cohorts on DeSurv gene signatures produces prognostic subtypes {.unnumbered}
To evaluate the generalizability of DeSurv-derived prognostic signatures, we applied the exemplar genes from the survival-associated factors in the trained model (Factors 1 and 3) to multiple independent PDAC cohorts—including Dijk, PACA-AU (RNA-seq and microarray), Moffitt, and Puleo datasets—using their bulk gene-expression profiles. Unsupervised consensus clustering was performed on each cohort based on the expression of these prognostic genes. Three clusters were selected as the optimal solution, supported by inspection of the cumulative distribution function (CDF) plots, relative change in area under the CDF curve, consensus heatmaps, and cluster consensus scores (Fig. SX). Importantly, the number of clusters was determined without incorporating any survival information, ensuring an unbiased evaluation of downstream prognostic performance.

Expression heatmaps of the DeSurv prognostic signatures revealed three distinct transcriptional patterns across the external cohorts (Fig. 4A). Cluster 1 displayed high expression of the basal-like (Factor 3) gene set; Cluster 2 showed elevated expression of the immune/iCAF (Factor 1) signature and reduced basal activity; and Cluster 3 exhibited intermediate expression of both programs. These patterns suggest that survival prediction is primarily driven by the presence or absence of basal and immune/iCAF programs, rather than by a reciprocal contrast between basal versus classical tumor states or iCAF versus myCAF stromal signatures.

Additionally, DeSurv-derived clusters showed strong correspondence with established molecular classifiers. Column annotations in Fig. 4A and the contingency table in Fig. 4B demonstrate substantial overlap with PurIST and DeCAF subtype labels: for example, X% of patients in Cluster 1 were classified as PurIST Basal-like and DeCAF proCAF, X% of Cluster 2 as Classical + restCAF, and X% of Cluster 3 as Classical + proCAF. The rarity of the Basal + restCAF subtype likely contributes to the discovery of 3 rather than 4 clusters. A chi-squared test confirmed a significant association between the DeSurv-defined clusters and existing classifier labels ($\chi^2$ = 210.16 p < 2.2e-16).

We next assessed the prognostic relevance of these clusters using overall survival data from the external cohorts (Fig. XC–D). Because DeSurv was trained exclusively on the TCGA-PAAD and CPTAC datasets—without access to the expression or outcome data of the external cohorts—this analysis represents an independent validation of the model’s predictive generalizability. Kaplan–Meier analysis demonstrated that the DeSurv-derived clusters were strongly associated with survival (p = 4.8e-6). As expected, the Basal-like cluster (Cluster 1) was associated with the poorest survival, the Classical + restCAF cluster (Cluster 2) exhibited the most favorable outcomes, and the Classical + proCAF cluster (Cluster 3) showed intermediate survival. This pattern mirrors previous findings describing the interplay between tumor-intrinsic and stromal subtypes in PDAC (e.g., [@peng2024determination]), supporting the robustness and biological validity of the DeSurv-derived signatures.
```{r fig-clus, fig.cap="External cohort validation. A. Heatmap of expression values for genes in the DeSurv factor signatures in external cohorts. B. Table of DeSurv derived clusters by PurIST + DeCAF classifier subtypes in external cohorts. C. Kaplan Meier curves describing survival outcomes for patients from external cohorts in each of the DeSurv derived clusters.", fig.env='figure*', fig.pos='t', out.height= "4in", out.width='\\textwidth', eval=FALSE, include=FALSE}

# Figure generation temporarily disabled.
# knitr::include_graphics(file.path(repo_root, "figures", sprintf("fig_clus_%s_%s_%s.pdf", val_label, run_label, bo_label)))
```


## Analysis of scRNA-seq {.unnumbered}
Next, we verify our findings at the cellular level using the Elyada scRNA-seq data (cite data). We found that our DeSurv factor 1 signature was expressed primarily in iCAF and B cells, factor 2 was expressed in Acinar and Classical PDAC 2, and factor 3 was expressed primarily in Basal-like PDAC cells (Figures 4B-E). This is consistent with our ORA analysis which found that factor 1 was mostly immune and factor 3 was basal-like, and with the overlap we saw with published gene lists that identified factor 1 as iCAF/classical/immune and factor 3 as basal-like. Interestingly, we do not see a large overlap of factor 1 with the classical PDAC cell types despite some overlap with classical gene lists. Need more here...

```{r fig-sc, fig.cap="A. Cell type clusters from the Elyada scRNA-seq data. B-D. VAM scores for the DeSurv factor signatures in each cell shown on the UMAP of cells in the Elyada-sc data. E. Heatmap of average VAM scores by cell type and factor signature in the Elyada-sc data.", fig.env='figure*', fig.pos='t', out.height= "8in", out.width='\\textwidth'}

knitr::include_graphics(file.path(repo_root, "figures", sprintf("fig_sc_%s_%s.pdf", run_label, bo_label)))
```
