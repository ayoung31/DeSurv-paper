```{r setup}
library(targets)
library(stringr)
library(dplyr)
library(ggplot2)
library(survival)
library(survminer)
library(cowplot)
library(enrichplot)
library(magick)
library(Seurat)
library(gt)
library(VAM)
library(grid)
library(viridis)
library(ggplotify)
library(NMF)

repo_root <- normalizePath(if (file.exists("_targets.R")) "." else "..")

get_param_value <- function(name, default = NULL) {
  if (!exists("params", inherits = TRUE)) {
    return(default)
  }
  value <- params[[name]]
  if (is.null(value)) {
    return(default)
  }
  if (is.character(value) && !nzchar(value)) {
    return(default)
  }
  value
}

store <- tryCatch(tar_config_get("store"), error = function(e) "")
if (is.list(store)) {
  store <- store$store
}
if (!is.null(store) && nzchar(store)) {
  meta_check <- file.path(store, "meta", "meta")
  if (!file.exists(meta_check)) {
    store <- ""
  }
}
if (is.null(store) || !nzchar(store)) {
  store <- get_param_value("tar_store", "")
  if (is.null(store) || !nzchar(store)) {
    store <- "store_PKG_VERSION=tie_handling_GIT_BRANCH=main"
  }
  tar_config_set(store = store)
}

get_store_targets <- function(store_path) {
  meta_path <- file.path(store_path, "meta", "meta")
  if (!file.exists(meta_path)) {
    return(character(0))
  }
  meta <- read.delim(
    meta_path,
    sep = "|",
    header = TRUE,
    quote = "",
    comment.char = "",
    fill = TRUE,
    stringsAsFactors = FALSE
  )
  unique(meta$name)
}

invisible(lapply(list.files(file.path(repo_root, "R"), full.names = TRUE, pattern = "[.]R$"), source))
source(file.path(repo_root, "targets_bo_configs.R"))
source(file.path(repo_root, "targets_run_configs.R"))
source(file.path(repo_root, "targets_val_configs.R"))
source(file.path(repo_root, "targets_figure_configs.R"))

cmb_path <- file.path(repo_root, "data", "derv", "cmbSubtypes_formatted.RData")
if (file.exists(cmb_path)) {
  load(cmb_path)
}

bo_configs <- resolve_desurv_bo_configs(targets_bo_configs())
run_configs <- resolve_desurv_run_configs(targets_run_configs())
val_configs <- resolve_desurv_val_configs(targets_val_configs())
figure_configs <- targets_figure_configs()

available_targets <- get_store_targets(store)

paper_keys <- figure_configs$paper_figure_keys
paper_keys$bo_key <- "tcgacptac"
paper_keys$run_key <- "tcgacptac"
paper_keys$val_key <- "tcgacptac"

bo_label <- get_param_value("bo_label", "")
if (!nzchar(bo_label) && !is.null(paper_keys$bo_key) && nzchar(paper_keys$bo_key)) {
  bo_label <- paper_keys$bo_key
}
available_bo_targets <- grep("^tar_params_best_", available_targets, value = TRUE)
available_bo_targets <- available_bo_targets[!grepl("^tar_params_best_alpha0_", available_bo_targets)]
available_bo_labels <- sub("^tar_params_best_", "", available_bo_targets)
if (!nzchar(bo_label) || (length(available_bo_labels) && !bo_label %in% available_bo_labels)) {
  preferred_bo <- character(0)
  if (length(run_configs)) {
    preferred_bo <- unlist(lapply(run_configs, function(cfg) cfg$bo_key))
  }
  preferred_bo <- unique(preferred_bo[!is.na(preferred_bo) & nzchar(preferred_bo)])
  match_bo <- preferred_bo[preferred_bo %in% available_bo_labels][1]
  if (!is.na(match_bo) && nzchar(match_bo)) {
    bo_label <- match_bo
  } else if (length(available_bo_labels)) {
    bo_label <- available_bo_labels[1]
  } else if (length(bo_configs)) {
    bo_label <- names(bo_configs)[1]
  }
}
run_label <- get_param_value("run_label", "")
if (!nzchar(run_label) && !is.null(paper_keys$run_key) && nzchar(paper_keys$run_key)) {
  run_label <- paper_keys$run_key
}
run_candidates <- grep("^tar_fit_desurv_", available_targets, value = TRUE)
run_candidates <- run_candidates[!grepl("^tar_fit_desurv_alpha0_", run_candidates)]
if (nzchar(bo_label) && length(run_candidates)) {
  run_candidates <- run_candidates[grepl(paste0("_", bo_label, "$"), run_candidates)]
}
available_run_labels <- unique(sub("^tar_fit_desurv_", "", run_candidates))
if (nzchar(bo_label) && length(available_run_labels)) {
  available_run_labels <- sub(paste0("_", bo_label, "$"), "", available_run_labels)
}
if (!nzchar(run_label) || (length(available_run_labels) && !run_label %in% available_run_labels)) {
  if (length(available_run_labels)) {
    run_label <- available_run_labels[1]
  } else if (length(run_configs)) {
    run_label <- names(run_configs)[1]
  }
}
val_label <- get_param_value("val_label", "")
if (!nzchar(val_label) && !is.null(paper_keys$val_key) && nzchar(paper_keys$val_key)) {
  val_label <- paper_keys$val_key
}
if (!nzchar(val_label)) {
  if (length(val_configs)) {
    val_label <- names(val_configs)[1]
  } else {
    val_label <- ""
  }
}

make_target_name <- function(base, bo_label, run_label = NULL, val_label = NULL) {
  parts <- c(base, val_label, run_label, bo_label)
  parts <- parts[!is.na(parts) & nzchar(parts)]
  paste(parts, collapse = "_")
}

resolve_target_name <- function(base, bo_label, run_label = NULL, val_label = NULL, available = character(0)) {
  candidates <- unique(c(
    make_target_name(base, bo_label, run_label, val_label),
    make_target_name(base, bo_label, run_label, NULL),
    make_target_name(base, bo_label, NULL, NULL),
    base
  ))
  candidates <- candidates[nzchar(candidates)]
  if (length(available)) {
    match <- candidates[candidates %in% available][1]
    if (!is.na(match) && nzchar(match)) {
      return(match)
    }
  }
  candidates[1]
}

best_params <- tar_read_raw(resolve_target_name(
  "tar_params_best",
  bo_label = bo_label,
  available = available_targets
))

```


## Model Overview {.unnumbered}

We have developed an integrated framework, DeSurv, that couples Nonnegative Matrix Factorization (NMF) with Cox proportional hazards regression to identify latent gene-expression programs associated with patient survival (Figure \@ref(fig:fig-schema)). The model takes as input a bulk expression matrix of $p$ genes by $n$ patients ($X_{Train}$) together with corresponding survival times ($y_{Train}$) and censoring indicators ($\delta_{Train}$) (Figure \@ref(fig:fig-schema)A). 

DeSurv optimizes a joint objective combining the NMF reconstruction loss and the Cox model's log-partial likelihood, weighted by a supervision parameter ($\alpha$) that determines the relative contribution of each term (Figure \@ref(fig:fig-schema)B):
\begin{align}
  (1-\alpha)\ &\mathcal{L}_{NMF}(X_{Train} \approx WH)\nonumber \\ - \alpha\ &\mathcal{L}_{Cox}(X_{Train}^TW\beta,y_{Train},\delta_{Train})
\end{align}
When $\alpha=0$, the method reduces to standard unsupervised NMF; when $\alpha>0$, survival information directly guides the learned factors toward prognostic structure. 

Within this framework, the product ($X_{Train}^TW$) represents patient-level factor scores - the inferred burden of each latent program across subjects. These factor scores serve as covariates in the Cox model, and their regression coefficients ($\beta$) indicate whether higher activity of a given program corresponds to improved or reduced survival. 

Model training yields gene weights ($\hat{W}$), factor loadings ($\hat{H}$), and Cox coefficients ($\hat{\beta}$) (Figure \@ref(fig:fig-schema)C), where the inner dimension ($k$) specifies the number of latent factors. Genes with high gene weights in one factor and low gene weights in all others define the factor-specific signature genes (Figure \@ref(fig:fig-schema)D). By integrating survival supervision into the factorization, DeSurv not only reconstructs the underlying expression structure, preserving biologial interpretability, but also guides latent factors to be prognostically informative. Subsequent analyses can therefore focus on the survival-associated gene programs (Figure \@ref(fig:fig-schema)E).
```{r fig-schema, fig.cap="DeSurv overview. Overview of the DeSurv training pipeline. A. The input is a preprocessed bulk gene expression matrix and patient survival outcomes. B. The Desurv model optimizes a joint NMF + Cox loss function. C. The DeSurv model estimates three quantities: Gene weights matrix (W), Subject loadings matrix (H), and regression coefficients from the Cox model (beta). D. We extract the exemplar genes from each signature in the gene weights matrix. E. The exemplar genes from survival associated factors provide prognostic gene signatures.", fig.env='figure*', fig.pos='t', out.height= "4in", out.width='\\textwidth'}

knitr::include_graphics(file.path(repo_root, "figures", "model_schematic_final.pdf"))
```



## Bayesian optimisation selects the DeSurv hyperparameters ($k$, $\alpha$) {.unnumbered}
We now tune DeSurv with Bayesian optimisation (BO) rather than enumerating a dense cross-validation grid. Each BO evaluation fits the model for a single combination of $k$, $\alpha$, and penalty weights, measuring the mean validation C-index. A Gaussian-process surrogate models this surface and proposes new evaluations that balance exploration and exploitation, allowing the search to concentrate rapidly on high-performing regions.

Figure \@ref(fig:fig-bo) summarises the optimisation run. Panel A reports the best observed cross-validated C-index at each $k$ for the supervised and $\alpha=0$ searches, with error bars denoting the cross-validation standard error across folds. The final configuration of the supervised search converges to $k=3$ and $\alpha=0.7$, which provided the highest cross-validated C-index encountered by BO.

For reference we still report standard NMF heuristics (Panels B-D: cophenetic, residuals, and silhouette), which historically guide rank selection when a supervised criterion is unavailable. These diagnostics disagree on the optimal $k$, underscoring the benefit of the BO-guided DeSurv procedure that explicitly maximises prognostic accuracy.

```{r fig-bo, fig.width = 6, fig.height= 5.5, fig.cap="A. Best observed CV C-index versus k for the supervised and $\\alpha$ = 0 searches with cross-validation SE error bars. B-D. Conventional NMF diagnostics (cophenetic, residuals, silhouette) for the unsupervised baseline." , fig.env='figure*', fig.pos='t', out.height= "5.5in", out.width="6in"}

knitr::include_graphics(file.path(
  repo_root,
  "figures",
  sprintf("fig_bo_%s.pdf", bo_label)
))
```


## DeSurv improves selection of prognostic gene signatures {.unnumbered}
To test whether supervision improves the selection of prognostic gene signatures, we used simulations with known lethal factors and tuned the number of top genes per factor (\texttt{n\_top}) using BO. We compared the supervised DeSurv model to the unsupervised $\alpha=0$ baseline across simulation regimes. Figure \@ref(fig:fig-sim-ntop)A shows the distribution of test C-index values, while Figure \@ref(fig:fig-sim-ntop)B reports the precision of recovered prognostic genes (mean across lethal factors). DeSurv consistently yields higher C-index and improved precision, indicating that survival supervision helps focus signatures on truly prognostic genes rather than reconstruction-only structure.

```{r fig-sim-ntop, fig.cap="Simulation results for BO-tuned signature size. A. Test C-index across simulation regimes for DeSurv and the $\\alpha=0$ baseline. B. Precision of recovered prognostic genes (mean across lethal factors).", fig.env='figure*', fig.pos='t', out.width='0.49\\textwidth'}
knitr::include_graphics(c(
  file.path(repo_root, "figures", "sim", "bo_tune_ntop", "sim_cindex_boxplot__combined.pdf"),
  file.path(repo_root, "figures", "sim", "bo_tune_ntop", "sim_precision_boxplot__combined.pdf")
))
```


## DeSurv provides biologically interpretable gene signatures {.unnumbered}
For the selected DeSurv model ($k=3, \alpha=0.7$), we identified the top 50 factor-specific genes from each latent factor to characterize their underlying biological functions. Panels A-C of Figure \@ref(fig:fig-bio) summarize the results of an over-representation analysis (ORA) performed on these genes. The enrichment profiles reveal three distinct biological programs. Factor 1 is strongly enriched for immune-related pathways, including cytokine signaling, T-cell activation, and interferon response. Factor 2 shows enrichment for genes associated with normal pancreatic or exocrine function, suggesting that this component captures residual normal-tissue signal. Factor 3 is enriched for pathways linked to epithelial–mesenchymal transition, cell cycle progression, and KRAS signaling—features typically associated with the Basal-like subtype of pancreatic ductal adenocarcinoma (PDAC).

Survival analysis of the factor signature scores on the training data demonstrates clear prognostic stratification. High expression of Factor 1 is associated with longer overall survival (HR = 0.37, p < 2e-16), whereas Factor 3 is linked to significantly shorter survival (HR = 1.43, p = 2e-4). These trends are consistent with known biology: immune-infiltrated tumors generally exhibit improved prognosis, while Basal-like tumors are aggressive and clinically refractory. Factor 2, corresponding to the normal/exocrine signal, shows no significant association with survival (HR = 0.99, p = 0.91), indicating that while this component contributes to reconstructing the expression matrix, it does not carry prognostic information. This behavior illustrates a key property of DeSurv—its joint optimization ensures that the latent factors balance both survival relevance and expression reconstruction, preserving biologically necessary structure even when not directly linked to outcome.

Panel D of Figure \@ref(fig:fig-bio) further examines the correlation between DeSurv factors and previously published PDAC gene signatures. Factor 1 aligns with signatures from classical tumor, iCAF and restCAF stroma, and immune infiltration, all of which are associated with favorable prognosis. In contrast, Factor 3 correlates with Basal-like tumor, proCAF, and activated stromal programs, which are generally linked to poor outcomes. These overlaps suggest that each factor represents a composite axis of tumor–stroma-immune interaction, capturing biologically coherent programs that align with known PDAC ecosystems but arise de novo from the DeSurv model.
```{r fig-bio, fig.cap="A-C. Dotplots of ORA analysis of top 50 genes from each DeSurv derived factor. D. Correlation between the DeSurv gene weights matrix and previously published PDAC gene signatures.", fig.env='figure*', fig.pos='t', out.height= "4.5in", out.width='\\textwidth'}

knitr::include_graphics(file.path(
  repo_root,
  "figures",
  sprintf("fig_bio_%s.pdf", bo_label)
))
```


## External validation with projected DeSurv factor scores {.unnumbered}
To evaluate the generalizability of DeSurv-derived prognostic signatures, we projected the DeSurv weights onto multiple independent PDAC cohorts (Dijk, PACA-AU RNA-seq and microarray, Moffitt, and Puleo). We selected the two most prognostic factors using \texttt{select\_desurv\_factors}, rank-transformed expression within each sample over the union of the selected factor gene lists, and computed validation scores as $Z_{val} = X_{val}^T W$ restricted to the top-gene signatures. This yields continuous factor score vectors for each cohort without clustering.

Figure \@ref(fig:fig-extval)A shows the ranked expression heatmap for the selected factor gene signatures, annotated with the continuous factor scores and the PurIST, DeCAF, and dataset labels. Figure \@ref(fig:fig-extval)B plots the top two factor scores for all samples, colored by PurIST subtype and shaped by DeCAF subtype to show how tumor- and stroma-associated programs align across cohorts. For survival assessment, we discretized each factor score within each cohort at its median and intersected the high/low calls to form four groups; Kaplan–Meier curves for these groups are shown in Figure \@ref(fig:fig-extval)C. Because DeSurv was trained only on TCGA-PAAD/CPTAC, these analyses represent an independent validation of prognostic signal transfer to external datasets.
```{r fig-extval, fig.cap="External cohort validation. A. Heatmap of ranked expression values for genes in the selected DeSurv factor signatures with continuous factor-score annotations plus PurIST, DeCAF, and dataset labels. B. Scatter plot of the top two factor scores, colored by PurIST subtype and shaped by DeCAF subtype. C. Kaplan–Meier curves for the four groups formed by per-cohort median splits of the two factor scores.", fig.env='figure*', fig.pos='t', out.height= "4in", out.width='\\textwidth'}

knitr::include_graphics(file.path(
  repo_root,
  "figures",
  sprintf("fig_extval_%s.pdf", bo_label)
))
```


## Bladder cancer analysis {.unnumbered}
We will report a focused bladder cancer analysis here, including a dedicated figure. Placeholder text: summary of bladder cohort preprocessing, DeSurv factor interpretation, and survival stratification results to be added once the bladder figure is finalized.
