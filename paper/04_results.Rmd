```{r setup}
library(targets)
library(stringr)
library(dplyr)
library(ggplot2)
library(survival)
library(survminer)
library(cowplot)
library(enrichplot)
library(magick)
library(Seurat)
library(gt)
library(VAM)
library(grid)
library(viridis)
library(ggplotify)
library(NMF)


tar_load(sim_figs_by_scenario)

tar_load(fig_extval_panel_a_tcgacptac)
tar_load(fig_extval_panel_b_tcgacptac)
tar_load(fig_extval_panel_c_tcgacptac)

tar_load(sim_figs_by_scenario)

scenario_ids = sapply(sim_figs_by_scenario,function(x) x$scenario_id)
analysis_ids = sapply(sim_figs_by_scenario,function(x) x$analysis_id)

# Auto-detect analysis method: prefer "bo_tune_ntop" (full pipeline), fall back to "bo" (quick mode)
preferred_analysis <- if ("bo_tune_ntop" %in% analysis_ids) "bo_tune_ntop" else "bo"
message("Using analysis method: ", preferred_analysis)

alt = which(scenario_ids=="R0_easy" & analysis_ids == preferred_analysis)
null = which(scenario_ids=="R00_null" & analysis_ids == preferred_analysis)

alt_plots = sim_figs_by_scenario[[alt]]
null_plots = sim_figs_by_scenario[[null]]

alt_plots = lapply(alt_plots, set_fig_font, size = 10)
null_plots = lapply(null_plots, set_fig_font, size = 10)
```


## Model Overview {.unnumbered}

We have developed an integrated framework, DeSurv, that couples Nonnegative Matrix Factorization (NMF) with Cox proportional hazards regression to identify latent gene-expression programs associated with patient survival (Figure \@ref(fig:fig-schema)). The model takes as input a bulk expression matrix of $p$ genes by $n$ patients ($X$) together with corresponding survival times ($y$) and censoring indicators ($\delta$) (Figure \ref{fig:schema}A). 

DeSurv optimizes a joint objective combining the NMF reconstruction loss and the Cox model's log-partial likelihood, weighted by a supervision parameter ($\alpha$) that determines the relative contribution of each term (fig. \ref{fig:schema}B):
\begin{align}
  (1-\alpha)\ &\mathcal{L}_{NMF}(X \approx WH)\nonumber \\ - \alpha\ &\mathcal{L}_{Cox}(Z^\top \beta,y,\delta)
\end{align}
When $\alpha=0$, the method reduces to standard unsupervised NMF; when $\alpha>0$, survival information directly guides the learned factors toward prognostic structure. 

Within this framework, the product ($W^\top X$) represents patient-level factor scores ($Z$) - the inferred burden of each latent program across subjects. These factor scores serve as covariates in the Cox model with linear predictor $Z^\top \beta$, and their regression coefficients ($\beta$) indicate whether higher activity of a given program corresponds to improved or reduced survival. 

Model training yields gene weights ($\hat{W}$), factor loadings ($\hat{H}$), and Cox coefficients ($\hat{\beta}$) (Figure \ref{fig:schema}C), where the inner dimension ($k$) specifies the number of latent factors. Genes with high gene weights in one factor and low gene weights in all others define the factor-specific signature genes (Figure \ref{fig:schema}D). By integrating survival supervision into the factorization, DeSurv not only reconstructs the underlying expression structure, preserving biological interpretability, but also guides latent factors to be prognostically informative. Subsequent analyses can therefore focus on the survival-associated gene programs (Figure \ref{fig:schema}E).
```{r fig-schema, fig.cap = "Overview of the DeSurv framework and data-driven model selection. (A) DeSurv integrates nonnegative matrix factorization (NMF) with survival modeling to learn prognostic gene programs from a gene expression matrix $X$. NMF decomposes $X \\approx WH$, where $W$ represents gene programs and $H$ sample loadings; the learned programs $W$ are shared with a Cox proportional hazards model that links factor-derived scores $Z = W^\\top X$ to survival outcomes via linear predictor $Z^\\top \\beta$. A tuning parameter $\\alpha$ controls the balance between unsupervised structure learning ($\\alpha = 0$) and supervised survival association ($\\alpha = 1$). (B) Model complexity ($k$), supervision strength ($\\alpha$), and regularization ($\\lambda$) are selected via Bayesian optimization using cross-validated concordance index. \\label{fig:schema}", fig.env='figure*', fig.pos='t', out.height= "6in", out.width='\\textwidth'}

knitr::include_graphics(file.path("..","figures", "model_schematic_final.pdf"))
```


## Outcome-guided model selection resolves ambiguity in NMF rank choice {.unnumbered}

We examined the problem of selecting the number of latent components ($k$) in nonnegative matrix factorization (NMF) using gene expression data from pancreatic ductal adenocarcinoma (PDAC) cohorts. These heterogeneous tumor transcriptomes provide a representative setting in which to evaluate how commonly used unsupervised rank-selection heuristics behave in practice.

Across a range of candidate ranks, standard NMF diagnostics yielded inconsistent guidance (Fig. \ref{fig:bo}A-C). Reconstruction residuals decreased smoothly with increasing $k$ and did not exhibit a clear elbow, a pattern consistent with both relatively small solutions ($k \approx 3$-4) and substantially larger ranks ($k \approx 6$-8). The cophenetic correlation coefficient began to decline at low ranks ($k \approx 3$-4) but continued to fluctuate at higher values without a distinct transition point. In contrast, mean silhouette width, evaluated across multiple distance metrics, was highest at very small ranks ($k \approx 2$-3) and decreased monotonically thereafter, favoring low-dimensional solutions that conflicted with recommendations based on reconstruction error or cophenetic correlation. Together, these unsupervised criteria pointed to different and incompatible values of $k$, highlighting the ambiguity of rank selection in standard NMF when applied to PDAC data.

To resolve this ambiguity, we applied DeSurv, which incorporates survival outcomes directly into the factorization process and evaluates models using survival-based predictive performance. Using the same PDAC gene expression data, we assessed model performance across the joint space of the number of components ($k$) and supervision strength ($\alpha$) using cross-validated concordance index (C-index). The resulting C-index surface summarizes expected predictive performance across candidate models and enables direct comparison of solutions that differ in both model complexity and degree of supervision (Fig. \ref{fig:bo}D).

Model selection was based on standard cross-validation principles. Rather than selecting the single parameter combination with the highest predicted C-index, we selected the smallest value of $k$ whose predicted performance lay within one standard error of the maximum. This criterion yielded a stable and parsimonious choice of model rank in the PDAC data, in contrast to the conflicting recommendations produced by unsupervised NMF heuristics.

To further evaluate rank recovery under controlled conditions, we conducted simulation studies in which the true underlying rank was known ($k = 3$). Across repeated simulation replicates, DeSurv consistently selected the correct rank, producing a concentrated distribution of selected $k$ values centered at the true value. In contrast, standard NMF followed by post hoc Cox modeling ($\alpha = 0$) exhibited substantially greater variability and a systematic tendency toward under-selection. Together, these results indicate that incorporating outcome information during model fitting improves the reliability of rank selection in settings where unsupervised criteria yield conflicting conclusions.

```{r fig-bo, fig.width = 6, fig.height= 5.5, fig.cap = "(A-D) Analyses based on real pancreatic ductal adenocarcinoma (PDAC) gene expression data illustrate the ambiguity of rank selection in standard nonnegative matrix factorization (NMF) and the use of outcome supervision in DeSurv. (A-C) Commonly used unsupervised heuristics for selecting the number of components (k) yield inconsistent conclusions. (A) Reconstruction residuals decrease smoothly with increasing k and do not exhibit a clear elbow; diminishing returns could be inferred at intermediate (k $\\approx$ 3-4) or larger (k $\\approx$ 6-8) ranks. (B) The cophenetic correlation coefficient, often used to select the largest k prior to a marked loss of clustering stability, begins to decline at low ranks (k $\\approx$ 3-4) but continues to fluctuate thereafter, providing no unambiguous selection criterion. (C) Mean silhouette width across multiple distance metrics is highest at small ranks (k $\\approx$ 2-3) and decreases monotonically with increasing k, favoring lower-dimensional solutions that conflict with the other criteria.(D) Heatmap of the Gaussian process predicted mean cross-validated concordance index (C-index) from Bayesian optimization over the joint space of the number of components (k) and supervision strength ($\\alpha$), computed on the same PDAC data. The predicted performance surface summarizes survival prediction accuracy across parameter settings and illustrates how DeSurv uses outcome information to inform model selection. (E) Results from simulation studies with a known underlying rank (k = 3) showing the distribution of selected k values across repeated replicates. DeSurv more consistently recovers the true rank, yielding a concentrated distribution centered at k = 3, whereas standard NMF with post hoc Cox modeling ($\\alpha=0$) exhibits greater variability and a tendency toward under-selection. \\label{fig:bo}", fig.env='figure*', fig.pos='t', out.height= "5.5in", out.width="6in"}

tar_load(fig_bo_heat_tcgacptac)
tar_load(fig_residuals_tcgacptac)
tar_load(fig_cophenetic_tcgacptac)
tar_load(fig_silhouette_tcgacptac)

fig_bo_heat_tcgacptac = set_fig_font(fig_bo_heat_tcgacptac, size = 10)
fig_residuals_tcgacptac = set_fig_font(fig_residuals_tcgacptac, size = 10)
fig_cophenetic_tcgacptac = set_fig_font(fig_cophenetic_tcgacptac, size = 10)
fig_silhouette_tcgacptac = set_fig_font(fig_silhouette_tcgacptac, size = 10)

# upper = plot_grid(fig_bo_cvk_tcgacptac,fig_bo_cvalpha_tcgacptac,labels=c("A","B"))
upper = plot_grid(fig_residuals_tcgacptac,
                  fig_cophenetic_tcgacptac,
                  fig_silhouette_tcgacptac,
                  ncol = 3,
                  labels = c("A","B","C"))

k_hist = plot_grid(alt_plots$k_hist,NULL,nrow=2,rel_heights = c(4,1))

lower = plot_grid(fig_bo_heat_tcgacptac,
                  k_hist,ncol=2,labels=c("D","E"),rel_widths = c(3,2))

plot_grid(upper,lower,nrow=2,rel_heights = c(2,3))

```


## DeSurv improves selection of prognostic gene signatures {.unnumbered}
To test whether supervision improves the selection of prognostic gene signatures, we used simulations with known lethal factors and tuned the number of top genes per factor (\texttt{n\_top}) using BO. We compared the supervised DeSurv model to the unsupervised $\alpha=0$ baseline across simulation regimes. Figure \ref{fig:sim}A shows the distribution of test C-index values, while Figure \ref{fig:sim}B reports the precision of recovered prognostic genes (mean across lethal factors). DeSurv consistently yields higher C-index and improved precision, indicating that survival supervision helps focus signatures on truly prognostic genes rather than reconstruction-only structure.
```{r fig-sim-ntop-scenarios, fig.width = 6.5, fig.height = 3, fig.cap = "Performance comparison between DeSurv and unsupervised NMF ($\\alpha = 0$) in simulation. (A) Distribution of cross-validated concordance index shows that DeSurv achieves consistently higher survival prediction performance than the unsupervised baseline. (B) Precision for recovering true underlying gene programs is substantially higher for DeSurv, whereas the unsupervised approach exhibits near-zero precision, indicating poor alignment with the ground-truth factors. \\label{fig:sim}", fig.env='figure*', fig.pos='t', out.width='\\textwidth'}



plot_grid(alt_plots$cindex_box + labs(title=NULL) + scale_y_continuous(limits=c(.5,1)),
          alt_plots$precision_box + labs(title=NULL),ncol=2,labels=c("A","B"))
```



## Survival-informed factorization reorganizes transcriptional structure in pancreatic cancer {.unnumbered}
To assess the biological structure captured by standard nonnegative matrix factorization (NMF) and DeSurv, we examined the overlap between factor-specific gene rankings and established PDAC gene programs (Fig. \ref{fig:bio}A-B). Both approaches recovered recognizable biological signals; however, the organization of these signals across factors differed in ways that reflect the objectives of each method.

In the standard NMF solution, factors largely reflected dominant sources of transcriptional variance. One factor was strongly associated with exocrine-associated expression and opposed immune and stromal signatures, consistent with a bulk composition axis separating normal or differentiated tissue from non-epithelial tumor content. A second factor aligned with classical tumor identity, while a third aggregated immune, fibroblast, and extracellular matrix–related programs into a single microenvironmental component. These patterns indicate that standard NMF captures major biological variation in bulk PDAC expression data, but merges distinct microenvironmental states and allocates substantial model capacity to differentiation-driven signals.

By contrast, DeSurv produced a factorization that emphasized axes of variation more closely aligned with disease aggressiveness. One factor corresponded to classical tumor programs opposing basal-like expression, whereas another isolated an activated microenvironmental state characterized by immune infiltration and stromal remodeling. A third factor captured aggressive tumor-intrinsic programs associated with basal-like biology. Notably, exocrine-associated expression did not dominate any DeSurv factor, suggesting that survival-informed optimization deprioritizes differentiation-related variation that is weakly associated with outcome.

These differences were reflected quantitatively by contrasting the fraction of expression variance explained by each factor with its contribution to survival (Fig. \ref{fig:bio}C). In the standard NMF solution, the factor explaining the largest proportion of transcriptional variance contributed little to survival, consistent with its enrichment for exocrine and composition-driven programs. In contrast, DeSurv concentrated survival signal into a single factor that explained substantially more variation in outcome despite accounting for a smaller fraction of expression variance. The remaining DeSurv factors contributed minimal survival signal, indicating that survival-relevant information was not diffusely distributed across components.

To further characterize how DeSurv reorganizes the transcriptional structure learned by standard NMF, we examined the correspondence between factors derived from the two methods (Fig. \ref{fig:bio}D). Tumor-intrinsic structure was largely preserved, with one DeSurv factor showing strong correspondence to the classical tumor–associated NMF factor. In contrast, the microenvironmental factor identified by standard NMF mapped primarily to a single DeSurv factor enriched for activated immune and stromal programs, indicating that DeSurv refines variance-driven microenvironmental structure into a survival-aligned axis. Notably, the NMF factor dominated by exocrine-associated expression did not correspond strongly to any single DeSurv factor, consistent with the suppression of differentiation- and composition-driven signals observed in survival-informed factorization. Together, these results indicate that DeSurv selectively preserves tumor and microenvironmental structure while reorganizing or deprioritizing axes of variation that contribute little to survival.
```{r fig-bio, fig.cap="Survival-informed factorization reorganizes transcriptional structure relative to variance-driven NMF. (A) Correlation of standard NMF factor gene rankings with established pancreatic ductal adenocarcinoma (PDAC) gene programs. NMF recovers variance-dominant structure, including an exocrine-associated factor opposing immune and stromal signatures, a classical tumor factor, and a composite microenvironmental factor. (B) Corresponding correlations for DeSurv. DeSurv isolates tumor-intrinsic classical and basal-like programs and resolves an activated immune–stromal microenvironment, while exocrine-associated expression does not dominate any factor. Asterisks indicate significant correlations after multiple testing correction. Only gene lists with correlation > 0.2 included in A and B. (C) Fraction of expression variance explained versus survival contribution for each factor, quantified by the change in partial log-likelihood from univariate Cox models. Standard NMF factors explain substantial variance with minimal survival relevance, whereas DeSurv concentrates survival signal into a single factor despite explaining less expression variance. (D) Pairwise correspondence between NMF and DeSurv factors. Tumor-intrinsic structure is preserved across methods, while variance-driven microenvironmental structure is reorganized into a survival-aligned axis; the exocrine-dominated NMF factor shows no strong one-to-one correspondence. \\label{fig:bio}", fig.env='figure*', fig.pos='t', out.height= "4.5in", out.width='\\textwidth'}

tar_load(fig_gene_overlap_heatmap_desurv_tcgacptac)
tar_load(fig_gene_overlap_heatmap_std_desurvk_tcgacptac)
tar_load(fig_variation_explained_tcgacptac)
tar_load(fig_desurv_std_correlation_tcgacptac)

fig_gene_overlap_heatmap_desurv_tcgacptac = set_fig_font(fig_gene_overlap_heatmap_desurv_tcgacptac, size = 10)
fig_gene_overlap_heatmap_std_desurvk_tcgacptac = set_fig_font(fig_gene_overlap_heatmap_std_desurvk_tcgacptac, size = 10)
fig_variation_explained_tcgacptac = set_fig_font(fig_variation_explained_tcgacptac, size = 10)
fig_desurv_std_correlation_tcgacptac = set_fig_font(fig_desurv_std_correlation_tcgacptac, size = 10)

bottom_right = plot_grid(NULL,fig_desurv_std_correlation_tcgacptac,ncol=2,rel_widths = c(1,4))

right = plot_grid(fig_variation_explained_tcgacptac +
                    theme(
                      legend.position = c(1, 0.65),   # x, y in [0,1]
                      legend.justification = c(1, 0),   # anchor point of legend box
                      legend.background = element_rect(color="black")
                    ),
          bottom_right,
          nrow=2,labels=c("C","D"),
          rel_heights = c(3,2))
legend = get_legend(fig_gene_overlap_heatmap_desurv_tcgacptac)
plot_grid(fig_gene_overlap_heatmap_std_desurvk_tcgacptac + theme(legend.position = "none"),fig_gene_overlap_heatmap_desurv_tcgacptac,right,ncol=3,labels=c("A","B",""),rel_widths = c(2.5,2.5,3))

```


## DeSurv-derived latent structure generalizes to independent datasets {.unnumbered}
To assess generalization of DeSurv latent factors, the gene-level signatures learned in the training cohort were used to compute factor activity scores in independent validation datasets. For each validation sample, factor activity was quantified by applying the learned gene-factor weights to the sample’s gene expression profile ($W^TX$), yielding a continuous score for each factor.

For each method, we focused on the factor showing the largest increase in Cox model log partial likelihood in the training data. Across validation cohorts, this DeSurv-derived factor exhibited consistent survival effects, with hazard ratio estimates showing limited variability and predominantly protective associations (Fig. \ref{fig:extval}A). In contrast, the NMF factor identified by the same criterion showed greater heterogeneity across datasets and weaker survival associations.

When validation samples were pooled and stratified into high- and low-activity groups based on the DeSurv-derived factor, clear separation of survival trajectories was observed (Fig. \ref{fig:extval}B). Applying the same procedure to NMF resulted in weaker survival stratification (Fig. \ref{fig:extval}C).

Together, these results indicate that DeSurv identifies latent factors whose associations with survival are preserved across datasets.
```{r fig-extval, fig.cap="DeSurv learns prognostic structure that generalizes across independent cohorts. (A) Forest plot summarizing hazard ratios (HRs; 95% CIs) for the latent factor most predictive of survival in held-out validation datasets. Estimates from DeSurv (blue) are more stable across cohorts than those obtained with standard NMF (red). (B) Kaplan–Meier curves for pooled validation samples stratified into high and low groups based on values of the DeSurv-derived factor providing the strongest survival signal. Median-based stratification yields clear separation of survival trajectories, indicating robust out-of-sample prognostic performance. (C) Corresponding analysis for the NMF-derived factor selected using the same survival-based criterion, showing weaker discrimination between risk groups. \\label{fig:extval}", fig.env='figure*', fig.pos='t', out.width='\\textwidth'}

tar_load(fig_hr_forest_tcgacptac)
tar_load(fig_median_survival_desurv_tcgacptac)
tar_load(fig_median_survival_std_desurvk_tcgacptac)

library(cowplot)
library(ggplot2)

# -------------------------
# Global styling knobs
# -------------------------
base_size <- 10

theme_pnas <- theme_classic(base_size = base_size) +
  theme(
    plot.title = element_text(face = "bold"),
    plot.margin = margin(6, 10, 6, 6),
    legend.box.margin = margin(0, 0, 0, 0),
    legend.spacing.x = unit(6, "pt"),
    legend.key.width = unit(12, "pt")
  )

# -------------------------
# Helper: stack KM plot + risk table with better spacing
# -------------------------
stack_surv <- function(surv_obj, keep_legend = FALSE) {
  p <- surv_obj$plot +
    theme_pnas +
    theme(
      legend.position = if (keep_legend) "bottom" else "none",
      axis.title.x = element_blank(),              # x-label goes on the table panel
      plot.margin = margin(6, 10, 2, 6)
    )

  # Risk table: smaller text, more top margin so it doesn't collide with x-axis
  t <- surv_obj$table +
    theme_pnas +
    theme(
      legend.position = "none",
      axis.title.y = element_blank(),
      axis.text.x  = element_text(size = base_size - 1),
      axis.text.y  = element_text(size = base_size - 1),
      plot.margin  = margin(2, 10, 6, 6)
    ) +
    labs(x = "Time (months)")

  plot_grid(p, t, ncol = 1, rel_heights = c(3.2, 1.3), align = "v", axis = "lr")
}

# -------------------------
# Panels B and C (KM + risk table)
# Keep legend only once (B), remove from C to reduce clutter
# -------------------------
med_desurv <- fig_median_survival_desurv_tcgacptac
mid  <- stack_surv(med_desurv, keep_legend = TRUE)

med_std <- fig_median_survival_std_desurvk_tcgacptac
right <- stack_surv(med_std, keep_legend = FALSE)

# -------------------------
# Panel A (forest): nicer spacing + readable y labels + stable margins
# -------------------------
left <- fig_hr_forest_tcgacptac +
  scale_y_discrete(
    labels = c(
      "Puleo_array"       = "Puleo",
      "Dijk"              = "Dijk",
      "PACA_AU_seq"       = "PACA seq",
      "PACA_AU_array"     = "PACA array",
      "Moffitt_GEO_array" = "Moffitt"
    )
  ) +
  theme_pnas +
  theme(
    legend.position = "bottom",
    axis.title.y = element_blank(),
    plot.margin = margin(6, 12, 6, 6)
  )

# -------------------------
# Build the 3-panel figure with consistent label placement
# -------------------------
plot_grid(
  left, mid, right,
  nrow = 1,
  rel_widths = c(3.2, 2.2, 2.2),
  labels = c("A", "B", "C"),
  label_size = 14,
  label_fontface = "bold",
  label_x = 0.02,
  label_y = 0.98,
  hjust = 0,
  vjust = 1
)

```


## Survival-informed factorization identifies prognostic structure across cancers {.unnumbered}
To assess whether the differences observed between standard nonnegative matrix factorization (NMF) and DeSurv in pancreatic ductal adenocarcinoma extend beyond a single disease context, we applied both methods to an independent bladder cancer cohort and evaluated factor structure, biological interpretation, and survival association using the same analytical framework (Fig. \ref{fig:bladder}).

In bladder cancer, standard NMF again organized transcriptional structure primarily around variance-dominant axes (Fig. \ref{fig:bladder}A). As in PDAC, NMF factors explained substantial fractions of expression variance but contributed little to survival, indicating that variance-driven factorization alone does not preferentially isolate prognostically relevant signals in this setting. This pattern mirrors the behavior observed in PDAC and suggests that the limitations of variance-only factorization are not cancer-type specific.

We next asked whether survival-aligned structure learned in PDAC could transfer across cancer types. Applying the DeSurv model trained in PDAC directly to bladder cancer samples, the survival-aligned factor retained prognostic relevance in the external cohort (Fig. \ref{fig:bladder}B). Kaplan–Meier analysis based on a median split of projected factor scores demonstrated clear separation of survival curves, despite differences in tissue context and transcriptional background. This result indicates that DeSurv learns latent representations that capture survival-relevant structure shared across cancers.

Together, these results show that survival-informed factorization separates variance-dominant from survival-relevant structure and that prognostic signal can transfer across cancer types. By deprioritizing variance-dominant but prognostically neutral signals and concentrating outcome-relevant information into a small number of factors, DeSurv identifies latent structure that is robust across cancers.

```{r fig-bladder, fig.cap="Survival-associated structure in bladder cancer is recovered by DeSurv and transfers across tumor types.(A) In bladder cancer, DeSurv identifies latent factors (F1, F2) with strong associations to survival, as measured by Cox partial log-likelihood, despite explaining only a small fraction of total expression variance. In contrast, factors derived from standard NMF explain substantially more variance but exhibit weak survival association. (B) Applying gene-level factor definitions learned in pancreatic ductal adenocarcinoma (PDAC) to bladder cancer samples yields clear separation of survival outcomes when patients are stratified by factor score (median split), with numbers at risk shown below. These results indicate that prognostically relevant structure may be weakly aligned with dominant transcriptional variation and can generalize across cancer types. \\label{fig:bladder}", fig.env='figure*', fig.pos='t', out.width='\\textwidth'}
tar_load(fig_variation_explained_bladder)
tar_load(raw_data_bladder)
tar_load(tar_data_filtered_tcgacptac)
data_bladder = readRDS(raw_data_bladder)
tar_load(tar_fit_desurv_tcgacptac)

fig_variation_explained_bladder = set_fig_font(fig_variation_explained_bladder, size = 10)

rownames(data_bladder$ex) = data_bladder$featInfo
data_bladder$sampInfo$time = data_bladder$sampInfo$os
data_bladder$sampInfo$event = data_bladder$sampInfo$censOS
data_bladder$samp_keeps = which(data_bladder$sampInfo$Consensus != "NE-like")
data_bladder$sampInfo$dataset = "bladder"

data_b_filtered = preprocess_validation_data(data_bladder,genes = rownames(tar_data_filtered_tcgacptac$ex),
                                             method_trans_train = 'rank',dataname="bladder")


keeps = intersect(rownames(data_b_filtered$ex),rownames(tar_fit_desurv_tcgacptac$W))

sampInfo = data_b_filtered$sampInfo
X = data_b_filtered$ex[keeps,]
W = tar_fit_desurv_tcgacptac$W[keeps,]

desurv_var <- build_variance_survival_df(
  X = tar_data_filtered_tcgacptac$ex,
  scores = tar_fit_desurv_tcgacptac$W,
  loadings = tar_fit_desurv_tcgacptac$H,
  time = tar_data_filtered_tcgacptac$sampInfo$time,
  event = tar_data_filtered_tcgacptac$sampInfo$event,
  method = "DeSurv"
)

desurv_fac = desurv_var$factor[which.max(desurv_var$delta_loglik)]

scores = t(X) %*% W

df = data_b_filtered$sampInfo
df$scores = scores[,desurv_fac]
med = median(df$scores)
bin=(df$scores>med)*1
df$factor = bin

sfit = survfit(Surv(time,event)~factor,data=df)
splot = ggsurvplot(sfit,data=df,risk.table = TRUE,
           xlab = "Time (months)",
           palette = c("violetred2","turquoise4"),
           break.time.by = 5,
           legend.labs=c('Low (< median)','High (≥ median)'),
           risk.table.y.text=FALSE,
           censor.size=2,
           font.main=10)

splot$plot = set_fig_font(splot$plot, size = 10)
splot$table = set_fig_font(splot$table, size = 10)

splot2 = plot_grid(splot$plot,splot$table,nrow=2,rel_heights=c(3,1))

plot_grid(fig_variation_explained_bladder,splot2,ncol=2,labels=c("A","B"))
```
