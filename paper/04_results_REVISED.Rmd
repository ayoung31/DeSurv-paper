<!-- REVISED RESULTS — prediction-validation structure for PNAS -->
<!-- All R code chunks are preserved from 04_results.Rmd -->
<!-- Prose revisions: bolded one-sentence summaries, prediction-validation transitions -->

```{r setup}
library(targets)
library(stringr)
library(dplyr)
library(ggplot2)
library(survival)
library(survminer)
library(cowplot)
library(enrichplot)
library(magick)
library(Seurat)
library(gt)
library(VAM)
library(grid)
library(viridis)
library(ggplotify)
library(NMF)


tar_load(sim_figs_by_scenario)

tar_load(fig_extval_panel_a_tcgacptac)
tar_load(fig_extval_panel_b_tcgacptac)
tar_load(fig_extval_panel_c_tcgacptac)

tar_load(sim_figs_by_scenario)

scenario_ids = sapply(sim_figs_by_scenario,function(x) x$scenario_id)
analysis_ids = sapply(sim_figs_by_scenario,function(x) x$analysis_id)

alt = which(scenario_ids=="R0_easy" & analysis_ids == "bo_tune_ntop")
null = which(scenario_ids=="R00_null" & analysis_ids == "bo_tune_ntop")

alt_plots = sim_figs_by_scenario[[alt]]
null_plots = sim_figs_by_scenario[[null]]

alt_plots = lapply(alt_plots, set_fig_font, size = 10)
null_plots = lapply(null_plots, set_fig_font, size = 10)

mixed = which(scenario_ids=="R_mixed" & analysis_ids == "bo_tune_ntop")
mixed_plots = sim_figs_by_scenario[[mixed]]
mixed_plots = lapply(mixed_plots, set_fig_font, size = 10)
```


## Model Overview {.unnumbered}

We developed DeSurv, a survival-supervised deconvolution framework that jointly optimizes NMF reconstruction and Cox proportional hazards likelihood (Fig. \ref{fig:schema}; Methods). The survival gradient acts on the gene program matrix $W$ but not on the sample loadings $H$, directing gene programs toward outcome-relevant structure while preserving interpretability of sample loadings as mixture coefficients [@lee1999learning; @gaujoux2010flexible]. We evaluated DeSurv in three settings: controlled simulations, PDAC cohort analysis with external validation, and cross-cancer transfer.
```{r fig-schema, fig.cap = "Overview of the DeSurv framework. (A) DeSurv jointly optimizes NMF reconstruction ($X \\approx WH$) and Cox proportional hazards likelihood. The gene program matrix $W$ is shared between objectives: factor scores $Z = W^\\top X$ serve as covariates in the Cox model with coefficients $\\beta$. A supervision parameter $\\alpha$ controls the balance between reconstruction fidelity ($\\alpha = 0$, standard NMF) and survival prediction ($\\alpha > 0$). (B) The factorization rank ($k$), supervision strength ($\\alpha$), and regularization ($\\lambda$) are selected via Bayesian optimization over cross-validated concordance index. \\label{fig:schema}", fig.env='figure*', fig.pos='t', out.height= "6in", out.width='\\textwidth'}

knitr::include_graphics(file.path("..","figures", "model_schematic_final.pdf"))
```


## Survival supervision clarifies NMF rank selection {.unnumbered}

Before examining DeSurv's performance across the three evaluation settings described above, we address a prerequisite question using both PDAC expression data and controlled simulations: whether incorporating clinical outcomes clarifies the well-documented instability of unsupervised rank selection heuristics [@frigyesi2008nmf; @brunet2004metagenes]. Using gene expression data from the PDAC training cohorts (TCGA [@tomczak2015review] and CPTAC [@ellis2013clinical]; Methods), we first evaluated commonly used unsupervised criteria across a range of candidate ranks.

Standard NMF diagnostics yielded inconsistent guidance (Fig. \ref{fig:bo}A-C). Reconstruction residuals decreased smoothly with increasing $k$ and did not exhibit a clear elbow, a pattern consistent with both relatively small solutions ($k \approx 3$-4) and substantially larger ranks ($k \approx 6$-8). The cophenetic correlation coefficient began to decline at low ranks ($k \approx 3$-4) but continued to fluctuate at higher values without a distinct transition point. In contrast, mean silhouette width was highest at very small ranks ($k \approx 2$-3) and decreased monotonically thereafter, favoring low-dimensional solutions that conflicted with the other criteria. Together, these unsupervised heuristics pointed to incompatible values of $k$, illustrating the ambiguity of rank selection in standard NMF.

To address this ambiguity, we applied DeSurv, which incorporates survival outcomes directly into the factorization and evaluates models using cross-validated concordance index (C-index). The resulting C-index surface across the joint space of factorization rank ($k$) and supervision strength ($\alpha$) identified a well-defined optimum, in contrast to the conflicting recommendations produced by unsupervised heuristics (Fig. \ref{fig:bo}D). Model selection followed the one-standard-error rule: we selected the smallest $k$ whose predicted performance lay within one standard error of the maximum, yielding a parsimonious choice. Bayesian optimization selected $k = `r tar_read(tar_k_selection_tcgacptac)$k_selected`$ and $\alpha = `r tar_read(tar_params_best_tcgacptac)$alpha`$ (C-index $`r round(tar_read(tar_k_selection_tcgacptac)$best_mean, 3)`$; 1-SE rule; $n = `r ncol(tar_read(tar_data_filtered_tcgacptac)$ex)`$ patients, $`r sum(tar_read(tar_data_filtered_tcgacptac)$sampInfo$event)`$ events).

To further evaluate rank recovery under controlled conditions, we conducted simulation studies in which the true underlying rank was known ($k = 3$). DeSurv consistently selected the correct rank, producing a concentrated distribution of selected $k$ values centered at the true value (Fig. \ref{fig:bo}E). In contrast, standard NMF followed by post hoc Cox modeling ($\alpha = 0$) exhibited substantially greater variability and a systematic tendency toward under-selection. These results support the prediction that incorporating outcome information into model selection improves recovery of the true factorization rank.

```{r fig-bo, fig.width = 6, fig.height= 5.5, fig.cap = "(A--D) Analyses based on pancreatic ductal adenocarcinoma (PDAC) gene expression data from TCGA and CPTAC cohorts. (A--C) Standard unsupervised rank selection heuristics yield inconsistent guidance for selecting the factorization rank $k$. (A) Reconstruction residuals as a function of $k$. (B) Cophenetic correlation coefficient as a function of $k$. (C) Mean silhouette width across multiple distance metrics as a function of $k$. (D) Gaussian process predicted mean cross-validated concordance index (C-index) from Bayesian optimization over the joint space of factorization rank ($k$) and supervision strength ($\\alpha$). (E) Simulation studies with known rank ($k = 3$): distribution of selected $k$ values across repeated replicates for DeSurv versus standard NMF with post hoc Cox modeling ($\\alpha = 0$). \\label{fig:bo}", fig.env='figure*', fig.pos='t', out.height= "5.5in", out.width="6in"}

tar_load(fig_bo_heat_tcgacptac)
tar_load(fig_residuals_tcgacptac)
tar_load(fig_cophenetic_tcgacptac)
tar_load(fig_silhouette_tcgacptac)

fig_bo_heat_tcgacptac = set_fig_font(fig_bo_heat_tcgacptac, size = 10)
fig_residuals_tcgacptac = set_fig_font(fig_residuals_tcgacptac, size = 10)
fig_cophenetic_tcgacptac = set_fig_font(fig_cophenetic_tcgacptac, size = 10)
fig_silhouette_tcgacptac = set_fig_font(fig_silhouette_tcgacptac, size = 10)

# upper = plot_grid(fig_bo_cvk_tcgacptac,fig_bo_cvalpha_tcgacptac,labels=c("A","B"))
upper = plot_grid(fig_residuals_tcgacptac,
                  fig_cophenetic_tcgacptac,
                  fig_silhouette_tcgacptac,
                  ncol = 3,
                  labels = c("A","B","C"))

k_hist = plot_grid(alt_plots$k_hist,NULL,nrow=2,rel_heights = c(4,1))

lower = plot_grid(fig_bo_heat_tcgacptac,
                  k_hist,ncol=2,labels=c("D","E"),rel_widths = c(3,2))

plot_grid(upper,lower,nrow=2,rel_heights = c(2,3))

```


## DeSurv recovers prognostic gene programs when variance and prognosis diverge {.unnumbered}

Sufficient dimension reduction theory predicts that outcome-guided subspace estimation recovers directions most relevant to the response [@cook2007fisher; @bair2006supervised], but this prediction has not been evaluated in the NMF deconvolution setting. To test whether it holds under nonnegative constraints with survival outcomes, we designed simulations with known ground-truth latent structure. Simulated expression matrices were generated from a nonnegative factor model in which prognostic gene programs explained low variance relative to outcome-neutral background signals, with survival times generated from marker gene expression ($p = 3{,}000$ genes, $n = 200$ samples, true $k = 3$; Methods). We compared DeSurv to standard NMF ($\alpha=0$) followed by post hoc Cox regression, with both methods tuned via cross-validated concordance index using Bayesian optimization.

In the primary scenario, where prognostic programs explained low variance relative to outcome-neutral programs, DeSurv consistently achieved higher C-index and substantially improved precision---the fraction of genes in a learned factor that belong to a true prognostic gene program---for recovering the true prognostic gene programs (Fig. \ref{fig:sim}A-B). The unsupervised baseline exhibited near-zero precision, indicating that variance-driven factorization failed to concentrate on the genes that actually drove survival. This result supports the prediction that outcome-guided learning recovers prognostic programs more reliably when variance and prognosis diverge. Across 100 replicates, DeSurv achieved median C-index $\textrm{[TODO]}$ versus $\textrm{[TODO]}$ for standard NMF ($\Delta = \textrm{[TODO]}$; $p = 3{,}000$ genes, $n = 200$ samples, true $k = 3$).

To verify that these gains reflect genuine signal recovery rather than overfitting, we repeated the analysis under two additional simulation scenarios (SI Appendix, Fig. S2). In a null scenario where survival times were generated independently of gene expression ($\beta = 0$), DeSurv defaulted to standard NMF: Bayesian optimization selected low supervision strength ($\alpha$), and both methods yielded C-index values near 0.5. This indicates that the semi-supervised design does not impose spurious prognostic structure when none exists. In a mixed scenario where survival depended on both factor-specific marker genes and shared background genes, creating partial overlap between variance-dominant and prognostically relevant structure, DeSurv's advantage was present but attenuated relative to the primary scenario. Together, these three scenarios establish that DeSurv's benefit scales with the degree of divergence between variance and prognosis: largest when prognostic programs explain low variance (primary scenario), moderate when variance and prognosis partially overlap (mixed), and absent when no survival signal exists (null).

```{r fig-sim-ntop-scenarios, fig.width = 6.5, fig.height = 3, fig.cap = "Performance comparison between DeSurv and standard NMF ($\\alpha = 0$) in the primary simulation scenario ($p = 3{,}000$ genes, $n = 200$ samples, true $k = 3$, 100 replicates), where prognostic programs explain low variance relative to outcome-neutral programs. Both methods were tuned via Bayesian optimization over cross-validated concordance index. (A) Test-set concordance index across simulation replicates. (B) Precision (fraction of genes in a learned factor belonging to a true prognostic gene program) across simulation replicates. Each point represents one replicate. \\label{fig:sim}", fig.env='figure*', fig.pos='t', out.width='\\textwidth'}



plot_grid(alt_plots$cindex_box + labs(title=NULL) + scale_y_continuous(limits=c(.5,1)),
          alt_plots$precision_box + labs(title=NULL),ncol=2,labels=c("A","B"))
```



## Survival supervision reorganizes the learned factor structure in PDAC {.unnumbered}

The dominant source of expression variance in PDAC, exocrine content, is not the dominant source of prognostic signal; DeSurv reorganizes the learned factor structure accordingly.

To directly test whether survival supervision reorganizes the learned factor structure, as predicted by the simulation results above, we examined the overlap between factor-specific gene rankings and established PDAC gene programs (Fig. \ref{fig:bio}A-B). Bayesian optimization selected $k = 3$ and $\alpha = 0.33$ for DeSurv in the PDAC training cohorts (TCGA and CPTAC). To enable a direct comparison of how each method organizes the same number of factors, we also fit standard NMF at the same rank ($k = 3$); results for standard NMF at independently selected ranks ($k = 5$ via elbow detection, $k = 7$ via cross-validated concordance at $\alpha = 0$) are presented in the SI Appendix.

DeSurv produced a factorization in which each factor aligned with a distinct, prognostically relevant biological program (Fig. \ref{fig:bio}A). One factor was enriched for classical tumor programs relative to basal-like expression, a second isolated an activated microenvironmental state characterized by immune infiltration and stromal remodeling, and a third captured aggressive tumor-intrinsic programs associated with basal-like biology. Notably, exocrine-associated expression did not dominate any DeSurv factor, suggesting that survival supervision deprioritizes differentiation-related variation that is weakly associated with outcome.

At the same rank, standard NMF organized the three factors around dominant sources of transcriptional variance rather than prognostic biology (Fig. \ref{fig:bio}B). One factor was strongly associated with exocrine expression and negatively correlated with immune and stromal signatures, consistent with a bulk composition axis separating normal or differentiated tissue from non-epithelial tumor content. A second factor aligned with classical tumor identity, while a third aggregated immune, fibroblast, and extracellular matrix-related programs into a single composite microenvironmental factor. These patterns indicate that, given the same number of factors, standard NMF allocates substantial model capacity to differentiation-driven signals and merges distinct microenvironmental states that DeSurv separates.

We quantified these differences by contrasting the fraction of expression variance explained by each factor with its contribution to survival (Fig. \ref{fig:bio}C). The NMF factor explaining the largest proportion of transcriptional variance contributed little to survival, consistent with its enrichment for exocrine and composition-driven programs. In contrast, DeSurv concentrated survival signal into a single factor that explained substantially more survival association despite accounting for a smaller fraction of expression variance. Specifically, the highest-variance NMF factor explained $\textrm{[TODO]}$% of expression variance but contributed $\Delta\ell = \textrm{[TODO]}$ to survival, whereas the DeSurv factor with the largest survival contribution explained $\textrm{[TODO]}$% of variance with $\Delta\ell = \textrm{[TODO]}$. The remaining DeSurv factors contributed minimal survival signal, indicating that survival-relevant information was not diffusely distributed across factors. This result directly illustrates the misalignment between variance and prognosis anticipated by sufficient dimension reduction theory [@cook2007fisher] and observed empirically in tumor purity analyses [@aran2015systematic]: the factors that explain the most transcriptomic variation need not be the factors most associated with patient outcomes. The observed pattern in PDAC, where the highest-variance factor shows minimal survival association while other factors show partial overlap between variance and prognosis, is consistent with the intermediate regime between the primary and mixed simulation scenarios, where DeSurv's advantage was largest.

To further characterize how the learned factor structure differs between DeSurv and standard NMF, we examined the correspondence between factors derived from the two methods (Fig. \ref{fig:bio}D). Tumor-intrinsic structure was largely preserved, with one DeSurv factor showing strong correspondence to the classical tumor-associated NMF factor. The microenvironmental factor identified by standard NMF mapped primarily to a single DeSurv factor enriched for activated immune and stromal programs, indicating that DeSurv refines variance-driven microenvironmental structure into a survival-aligned axis. Notably, the NMF factor dominated by exocrine expression did not correspond strongly to any single DeSurv factor, consistent with the suppression of differentiation- and composition-driven signals under survival supervision. Together, these results demonstrate that DeSurv selectively preserves tumor and microenvironmental structure while reorganizing or deprioritizing patterns of variation that contribute little to survival.
```{r fig-bio, fig.cap="Survival supervision reorganizes the learned factor structure relative to standard NMF in PDAC training data (TCGA and CPTAC). Both methods are compared at factorization rank $k = 3$, selected by DeSurv's Bayesian optimization; standard NMF at independently selected ranks is shown in SI Appendix. (A) Correlation of DeSurv factor gene rankings with established PDAC gene programs. (B) Corresponding correlations for standard NMF factors. Asterisks indicate significant correlations after multiple testing correction; only gene programs with $|r| > 0.2$ shown. (C) Fraction of expression variance explained versus survival contribution for each factor, quantified by the change in partial log-likelihood from univariate Cox models. (D) Pairwise correlation between NMF and DeSurv factor gene rankings, showing which biological programs are preserved, reorganized, or suppressed under survival supervision. \\label{fig:bio}", fig.env='figure*', fig.pos='t', out.height= "4.5in", out.width='\\textwidth'}

tar_load(fig_gene_overlap_heatmap_desurv_tcgacptac)
tar_load(fig_gene_overlap_heatmap_std_desurvk_tcgacptac)
tar_load(fig_variation_explained_tcgacptac)
tar_load(fig_desurv_std_correlation_tcgacptac)

fig_gene_overlap_heatmap_desurv_tcgacptac = set_fig_font(fig_gene_overlap_heatmap_desurv_tcgacptac, size = 10)
fig_gene_overlap_heatmap_std_desurvk_tcgacptac = set_fig_font(fig_gene_overlap_heatmap_std_desurvk_tcgacptac, size = 10)
fig_variation_explained_tcgacptac = set_fig_font(fig_variation_explained_tcgacptac, size = 10)
fig_desurv_std_correlation_tcgacptac = set_fig_font(fig_desurv_std_correlation_tcgacptac, size = 10)

bottom_right = plot_grid(NULL,fig_desurv_std_correlation_tcgacptac,ncol=2,rel_widths = c(1,4))

right = plot_grid(fig_variation_explained_tcgacptac +
                    theme(
                      legend.position = c(1, 0.65),   # x, y in [0,1]
                      legend.justification = c(1, 0),   # anchor point of legend box
                      legend.background = element_rect(color="black")
                    ),
          bottom_right,
          nrow=2,labels=c("C","D"),
          rel_heights = c(3,2))
legend = get_legend(fig_gene_overlap_heatmap_desurv_tcgacptac)
plot_grid(fig_gene_overlap_heatmap_desurv_tcgacptac,fig_gene_overlap_heatmap_std_desurvk_tcgacptac + theme(legend.position = "none"),right,ncol=3,labels=c("A","B",""),rel_widths = c(2.5,2.5,3))

```


## Survival-aligned programs generalize across independent PDAC cohorts {.unnumbered}

Having shown that DeSurv reorganizes the learned factor structure in the training data, we next tested whether this learned factor structure generalizes to independent cohorts. If outcome-guided subspaces capture biologically reproducible rather than noise-driven structure, they should transfer more readily across datasets [@cook2007fisher; @bair2006supervised]. We evaluated whether DeSurv factors maintain their prognostic associations in independent PDAC cohorts. We computed factor scores in each validation dataset by projecting the gene programs learned in the training cohort ($Z = W^\top X_{\text{new}}$), yielding a continuous score for each factor per sample.

For each method, we focused on the factor showing the largest increase in Cox model log partial likelihood in the training data. Across five independent PDAC cohorts ($n = \textrm{[TODO]}$), the DeSurv-derived factor exhibited consistent survival effects, with hazard ratio estimates showing limited variability and predominantly protective associations (pooled HR $\textrm{[TODO]}$; 95% CI $\textrm{[TODO]}$; log-rank $P = \textrm{[TODO]}$; Fig. \ref{fig:extval}A). In contrast, the NMF factor identified by the same criterion showed greater heterogeneity across datasets and weaker survival associations, consistent with the expectation that variance-driven programs capture cohort-specific variation that does not transfer.

We pooled validation samples and stratified them into high- and low-score groups based on a median split of the DeSurv-derived factor, observing clear separation of survival trajectories (Fig. \ref{fig:extval}B). The same procedure applied to NMF yielded weaker survival stratification (Fig. \ref{fig:extval}C). These results support the prediction that outcome-aligned programs capture biology that generalizes, whereas variance-driven programs may include cohort-specific signals that attenuate across datasets.

```{r fig-extval, fig.cap="External validation of DeSurv and standard NMF prognostic factors in independent PDAC cohorts, both at factorization rank $k = 3$. (A) Forest plot of hazard ratios (HRs; 95\\% CIs) for the factor with the largest training-set Cox partial log-likelihood contribution, evaluated in five held-out PDAC cohorts. DeSurv (blue) and standard NMF (red). (B) Kaplan--Meier curves for pooled validation samples stratified by median split of the DeSurv-derived factor score. (C) Corresponding median-split stratification for the standard NMF-derived factor. \\label{fig:extval}", fig.env='figure*', fig.pos='t', out.width='\\textwidth'}

tar_load(fig_hr_forest_tcgacptac)
tar_load(fig_median_survival_desurv_tcgacptac)
tar_load(fig_median_survival_std_desurvk_tcgacptac)

library(cowplot)
library(ggplot2)

# -------------------------
# Global styling knobs
# -------------------------
base_size <- 10

theme_pnas <- theme_classic(base_size = base_size) +
  theme(
    plot.title = element_text(face = "bold"),
    plot.margin = margin(6, 10, 6, 6),
    legend.box.margin = margin(0, 0, 0, 0),
    legend.spacing.x = unit(6, "pt"),
    legend.key.width = unit(12, "pt")
  )

# -------------------------
# Helper: stack KM plot + risk table with better spacing
# -------------------------
stack_surv <- function(surv_obj, keep_legend = FALSE) {
  p <- surv_obj$plot +
    theme_pnas +
    theme(
      legend.position = if (keep_legend) "bottom" else "none",
      axis.title.x = element_blank(),              # x-label goes on the table panel
      plot.margin = margin(6, 10, 2, 6)
    )

  # Risk table: smaller text, more top margin so it doesn't collide with x-axis
  t <- surv_obj$table +
    theme_pnas +
    theme(
      legend.position = "none",
      axis.title.y = element_blank(),
      axis.text.x  = element_text(size = base_size - 1),
      axis.text.y  = element_text(size = base_size - 1),
      plot.margin  = margin(2, 10, 6, 6)
    ) +
    labs(x = "Time (months)")

  plot_grid(p, t, ncol = 1, rel_heights = c(3.2, 1.3), align = "v", axis = "lr")
}

# -------------------------
# Panels B and C (KM + risk table)
# Keep legend only once (B), remove from C to reduce clutter
# -------------------------
med_desurv <- fig_median_survival_desurv_tcgacptac
mid  <- stack_surv(med_desurv, keep_legend = TRUE)

med_std <- fig_median_survival_std_desurvk_tcgacptac
right <- stack_surv(med_std, keep_legend = FALSE)

# -------------------------
# Panel A (forest): nicer spacing + readable y labels + stable margins
# -------------------------
left <- fig_hr_forest_tcgacptac +
  scale_y_discrete(
    labels = c(
      "Puleo_array"       = "Puleo",
      "Dijk"              = "Dijk",
      "PACA_AU_seq"       = "PACA seq",
      "PACA_AU_array"     = "PACA array",
      "Moffitt_GEO_array" = "Moffitt"
    )
  ) +
  theme_pnas +
  theme(
    legend.position = "bottom",
    axis.title.y = element_blank(),
    plot.margin = margin(6, 12, 6, 6)
  )

# -------------------------
# Build the 3-panel figure with consistent label placement
# -------------------------
plot_grid(
  left, mid, right,
  nrow = 1,
  rel_widths = c(3.2, 2.2, 2.2),
  labels = c("A", "B", "C"),
  label_size = 14,
  label_fontface = "bold",
  label_x = 0.02,
  label_y = 0.98,
  hjust = 0,
  vjust = 1
)

```


## A PDAC-trained program retains prognostic signal in bladder cancer {.unnumbered}

A PDAC-trained DeSurv program retains prognostic relevance in bladder cancer, consistent with shared basal-like transcriptional biology across epithelial cancers.

Finally, we tested whether the misalignment between variance and prognosis extends beyond PDAC and whether survival-aligned programs transfer across cancer types, a prediction motivated by prior evidence that basal-like transcriptional structure generalizes across epithelial cancers [@damrauer2014intrinsic; @Hoadley2018]. We first applied both standard NMF and DeSurv to an independent bladder cancer cohort and evaluated factor structure and survival association (Fig. \ref{fig:bladder}A). We then asked whether the DeSurv model trained in PDAC retains prognostic relevance when projected to bladder cancer samples (Fig. \ref{fig:bladder}B).

In bladder cancer, standard NMF again organized the learned factor structure primarily around variance-dominant patterns (Fig. \ref{fig:bladder}A). As in PDAC, NMF factors explained substantial fractions of expression variance but contributed little to survival, replicating the misalignment between variance and prognosis observed in PDAC.

Separately, we projected the DeSurv model trained in PDAC directly onto bladder cancer samples to test cross-cancer transfer. The survival-aligned factor retained prognostic relevance in the external cohort (Fig. \ref{fig:bladder}B). Kaplan-Meier analysis based on a median split of projected factor scores demonstrated clear separation of survival curves, despite differences in tissue context and transcriptional background ($n = \textrm{[TODO]}$, $\textrm{[TODO]}$ events; log-rank $P = \textrm{[TODO]}$; HR $\textrm{[TODO]}$; 95% CI $\textrm{[TODO]}$). This finding suggests that survival supervision captures cross-cancer biology that unsupervised methods may distribute across multiple outcome-neutral factors.

Together, these results suggest that survival supervision separates variance-dominant from survival-relevant structure and that this separation can transfer across cancer types, providing initial evidence that outcome-guided dimension reduction targets different subspaces than variance-driven reduction.

```{r fig-bladder, fig.cap="Survival-associated factor structure in bladder cancer and cross-cancer transfer from PDAC. (A) Fraction of expression variance explained versus survival contribution (change in Cox partial log-likelihood) for each factor in bladder cancer, comparing DeSurv and standard NMF. (B) Kaplan--Meier curves for bladder cancer samples stratified by median split of projected factor scores from a PDAC-trained DeSurv model, with numbers at risk shown below. \\label{fig:bladder}", fig.env='figure*', fig.pos='t', out.width='\\textwidth'}
tar_load(fig_variation_explained_bladder)
tar_load(raw_data_bladder)
tar_load(tar_data_filtered_tcgacptac)
data_bladder = readRDS(raw_data_bladder)
tar_load(tar_fit_desurv_tcgacptac)

fig_variation_explained_bladder = set_fig_font(fig_variation_explained_bladder, size = 10)

rownames(data_bladder$ex) = data_bladder$featInfo
data_bladder$sampInfo$time = data_bladder$sampInfo$os
data_bladder$sampInfo$event = data_bladder$sampInfo$censOS
data_bladder$samp_keeps = which(data_bladder$sampInfo$Consensus != "NE-like")
data_bladder$sampInfo$dataset = "bladder"

data_b_filtered = preprocess_validation_data(data_bladder,genes = rownames(tar_data_filtered_tcgacptac$ex),
                                             method_trans_train = 'rank',dataname="bladder",
                                             zero_fill_missing = TRUE)


keeps = intersect(rownames(data_b_filtered$ex),rownames(tar_fit_desurv_tcgacptac$W))

sampInfo = data_b_filtered$sampInfo
X = data_b_filtered$ex[keeps,]
W = tar_fit_desurv_tcgacptac$W[keeps,]

desurv_var <- build_variance_survival_df(
  X = tar_data_filtered_tcgacptac$ex,
  scores = tar_fit_desurv_tcgacptac$W,
  loadings = tar_fit_desurv_tcgacptac$H,
  time = tar_data_filtered_tcgacptac$sampInfo$time,
  event = tar_data_filtered_tcgacptac$sampInfo$event,
  method = "DeSurv"
)

desurv_fac = desurv_var$factor[which.max(desurv_var$delta_loglik)]

scores = t(X) %*% W

df = data_b_filtered$sampInfo
df$scores = scores[,desurv_fac]
med = median(df$scores)
bin=(df$scores>med)*1
df$factor = bin

sfit = survfit(Surv(time,event)~factor,data=df)
splot = ggsurvplot(sfit,data=df,risk.table = TRUE,
           xlab = "Time (months)",
           palette = c("violetred2","turquoise4"),
           break.time.by = 5,
           legend.labs=c('Low (< median)','High (≥ median)'),
           risk.table.y.text=FALSE,
           censor.size=2,
           font.main=10)

splot$plot = set_fig_font(splot$plot, size = 10)
splot$table = set_fig_font(splot$table, size = 10)

splot2 = plot_grid(splot$plot,splot$table,nrow=2,rel_heights=c(3,1))

plot_grid(fig_variation_explained_bladder,splot2,ncol=2,labels=c("A","B"))
```
